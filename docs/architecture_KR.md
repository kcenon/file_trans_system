# 아키텍처 개요

이 문서는 **file_trans_system**의 아키텍처에 대한 종합적인 개요를 제공합니다. 시스템 계층, 컴포넌트 관계, 설계 패턴을 포함합니다.

**버전**: 2.0.0
**최종 업데이트**: 2025-12-11

## 목차

1. [시스템 개요](#시스템-개요)
2. [클라이언트-서버 아키텍처](#클라이언트-서버-아키텍처)
3. [계층화된 아키텍처](#계층화된-아키텍처)
4. [컴포넌트 다이어그램](#컴포넌트-다이어그램)
5. [파이프라인 아키텍처](#파이프라인-아키텍처)
6. [데이터 흐름](#데이터-흐름)
7. [설계 패턴](#설계-패턴)
8. [스레딩 모델](#스레딩-모델)
9. [메모리 관리](#메모리-관리)
10. [보안 고려사항](#보안-고려사항)

---

## 시스템 개요

file_trans_system은 **클라이언트-서버 아키텍처**와 **다단계 파이프라인**을 기반으로 구축된 고성능 파일 전송 라이브러리입니다. 설계 시 우선순위는 다음과 같습니다:

- **처리량**: 병렬 처리를 통한 데이터 전송 속도 극대화
- **양방향 전송**: 업로드(클라이언트→서버)와 다운로드(서버→클라이언트) 모두 지원
- **신뢰성**: 체크섬과 검증을 통한 데이터 무결성 보장
- **재개 가능성**: 중단된 전송 복구 지원
- **자동 재연결**: 네트워크 끊김 시 자동 복구
- **확장성**: 다수의 동시 클라이언트를 효율적으로 처리
- **메모리 효율성**: 파일 크기와 무관하게 제한된 메모리 사용

---

## 클라이언트-서버 아키텍처

### 토폴로지 개요

```
                    ┌─────────────────────────────────────────┐
                    │         file_transfer_server            │
                    │                                         │
                    │  ┌─────────────────────────────────┐    │
                    │  │        Storage Directory        │    │
                    │  │           /data/files/          │    │
                    │  └─────────────────────────────────┘    │
                    │                                         │
                    │  - 최대 100+ 동시 연결 처리              │
                    │  - 업로드/다운로드 요청 검증             │
                    │  - 저장소 할당량 관리                    │
                    │  - 파일 목록 제공                        │
                    └───────────────┬─────────────────────────┘
                                    │
                                    │ TCP/TLS 1.3
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        │                           │                           │
        ▼                           ▼                           ▼
┌───────────────────┐       ┌───────────────────┐       ┌───────────────────┐
│    Client A       │       │    Client B       │       │    Client C       │
│                   │       │                   │       │                   │
│  upload_file()    │       │  download_file()  │       │   list_files()    │
│  다운로드도 가능  │       │  업로드도 가능    │       │  업/다운로드 가능 │
│                   │       │                   │       │                   │
│  자동 재연결      │       │  자동 재연결      │       │  자동 재연결      │
└───────────────────┘       └───────────────────┘       └───────────────────┘
```

### 서버 역할

| 역할 | 설명 |
|------|------|
| **파일 저장소** | 업로드된 파일을 지정된 디렉토리에 저장 |
| **연결 관리** | 다수의 클라이언트 연결 관리 |
| **요청 검증** | 업로드/다운로드 요청을 콜백으로 검증 |
| **할당량 관리** | 저장소 용량 및 파일 크기 제한 적용 |
| **파일 목록** | 저장된 파일 목록 제공 |

### 클라이언트 역할

| 역할 | 설명 |
|------|------|
| **양방향 전송** | 업로드와 다운로드 모두 수행 가능 |
| **자동 재연결** | 연결 끊김 시 지수 백오프로 재연결 |
| **진행 상황 추적** | 전송 진행률 및 속도 모니터링 |
| **전송 재개** | 중단된 전송 자동 재개 |

---

## 계층화된 아키텍처

### 고수준 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              APPLICATION                                     │
│                                                                              │
│         ┌─────────────────────┐       ┌─────────────────────┐               │
│         │file_transfer_server │       │file_transfer_client │               │
│         └──────────┬──────────┘       └──────────┬──────────┘               │
│                    │                             │                           │
├────────────────────┼─────────────────────────────┼───────────────────────────┤
│                    │        CORE LAYER           │                           │
│         ┌──────────▼──────────┐       ┌──────────▼──────────┐               │
│         │   server_pipeline   │       │   client_pipeline   │               │
│         │                     │       │                     │               │
│         │ [업로드]            │       │ [업로드]            │               │
│         │ 수신→해제→검증→쓰기 │       │ 읽기→압축→전송      │               │
│         │                     │       │                     │               │
│         │ [다운로드]          │       │ [다운로드]          │               │
│         │ 읽기→압축→전송      │       │ 수신→해제→검증→쓰기 │               │
│         └──────────┬──────────┘       └──────────┬──────────┘               │
│                    │                             │                           │
├────────────────────┼─────────────────────────────┼───────────────────────────┤
│                    │       SERVICE LAYER         │                           │
│    ┌───────────────┴───────────────┬─────────────┴───────────────┐          │
│    │                               │                             │          │
│    ▼                               ▼                             ▼          │
│ ┌──────────────┐           ┌──────────────┐           ┌──────────────┐      │
│ │chunk_manager │           │chunk_compressor│         │   checksum   │      │
│ │              │           │              │           │              │      │
│ │ ├ splitter   │           │ ├ lz4_engine │           │ ├ crc32      │      │
│ │ └ assembler  │           │ └ adaptive   │           │ └ sha256     │      │
│ └──────────────┘           └──────────────┘           └──────────────┘      │
│                                                                              │
│ ┌──────────────┐           ┌──────────────────┐                             │
│ │resume_handler│           │ storage_manager  │ (서버 전용)                 │
│ └──────────────┘           └──────────────────┘                             │
│                                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                           TRANSPORT LAYER                                    │
│                                                                              │
│    ┌──────────────────────────────────────────────────────────────────┐     │
│    │                    transport_interface                            │     │
│    └─────────────────────────────┬────────────────────────────────────┘     │
│                                  │                                           │
│              ┌───────────────────┼───────────────────┐                      │
│              │                   │                   │                      │
│              ▼                   ▼                   ▼                      │
│       ┌────────────┐      ┌────────────┐      ┌────────────┐               │
│       │tcp_transport│      │quic_transport│    │   mock     │               │
│       │ (TLS 1.3)  │      │  (Phase 2) │      │ (testing)  │               │
│       └────────────┘      └────────────┘      └────────────┘               │
│                                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                          INFRASTRUCTURE LAYER                                │
│                                                                              │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │common_system│  │thread_system│ │network_system│ │container_  │            │
│  │            │  │            │  │            │  │   system   │            │
│  │ Result<T>  │  │typed_thread │  │   socket   │  │  bounded   │            │
│  │ error      │  │   _pool    │  │   buffer   │  │   queue    │            │
│  │ time       │  │ job_queue  │  │            │  │            │            │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘            │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 계층 1: API 계층

**API 계층**은 애플리케이션을 위한 공개 인터페이스를 제공합니다.

| 클래스 | 목적 | 주요 메서드 |
|-------|------|------------|
| `file_transfer_server` | 파일 저장소 관리 및 클라이언트 처리 | `start()`, `stop()`, `on_upload_request()`, `on_download_request()` |
| `file_transfer_client` | 서버 연결 및 파일 전송 | `connect()`, `upload_file()`, `download_file()`, `list_files()` |

**설계 원칙**: 유연한 설정을 위한 Builder 패턴, 콜백 기반 이벤트 처리.

### 계층 2: Core 계층

**Core 계층**은 파이프라인 처리 로직을 구현합니다.

| 컴포넌트 | 목적 |
|---------|------|
| `server_pipeline` | 업로드 수신/다운로드 송신 처리 조율 |
| `client_pipeline` | 업로드 송신/다운로드 수신 처리 조율 |

**설계 원칙**: 제한된 큐를 사용한 스테이지 기반 병렬 처리.

### 계층 3: Service 계층

**Service 계층**은 재사용 가능한 처리 컴포넌트를 제공합니다.

| 컴포넌트 | 목적 |
|---------|------|
| `chunk_splitter` | 파일을 청크로 분할 |
| `chunk_assembler` | 청크를 파일로 재조립 |
| `chunk_compressor` | 청크 압축/압축 해제 |
| `lz4_engine` | 저수준 LZ4 연산 |
| `adaptive_compression` | 압축 가능성 감지 |
| `checksum` | CRC32 및 SHA-256 연산 |
| `resume_handler` | 전송 상태 영속화 및 재개 |
| `storage_manager` | 서버 저장소 관리 (서버 전용) |
| `auto_reconnect_handler` | 자동 재연결 로직 (클라이언트 전용) |

**설계 원칙**: 단일 책임, 가능한 경우 무상태.

### 계층 4: Transport 계층

**Transport 계층**은 네트워크 통신을 추상화하며 **network_system**을 사용하여 구현됩니다.

| 컴포넌트 | 목적 |
|---------|------|
| `transport_interface` | 추상 전송 API |
| `tcp_transport` | TCP + TLS 1.3 구현 **(network_system 사용)** |
| `quic_transport` | QUIC 구현 **(network_system, Phase 2)** |
| `transport_factory` | 전송 생성을 위한 팩토리 |

**설계 원칙**: 플러그인 가능한 전송을 위한 Strategy 패턴.

> **참고**: TCP와 QUIC 전송 모두 **network_system**에서 제공됩니다.

### 계층 5: Infrastructure 계층

**Infrastructure 계층**은 kcenon 생태계의 기반 유틸리티를 제공합니다.

| 시스템 | 사용되는 컴포넌트 |
|--------|-----------------|
| common_system | `Result<T>`, 오류 코드, 시간 유틸리티 |
| thread_system | 병렬 파이프라인 처리를 위한 `typed_thread_pool<pipeline_stage>` |
| **network_system** | **TCP/TLS 전송, QUIC 전송, 소켓 관리, 버퍼** |
| container_system | 백프레셔를 위한 `bounded_queue<T>` |

---

## 컴포넌트 다이어그램

### 서버 컴포넌트

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          file_transfer_server                                 │
│                                                                              │
│  설정:                           메서드:                                      │
│  ├ storage_directory             ├ start()                                  │
│  ├ max_connections               ├ stop()                                   │
│  ├ max_file_size                 ├ on_upload_request()                      │
│  ├ storage_quota                 ├ on_download_request()                    │
│  └ transport_type                └ get_statistics()                         │
│                                                                              │
│  콜백:                                                                       │
│  ├ on_client_connected()                                                    │
│  ├ on_client_disconnected()                                                 │
│  ├ on_transfer_complete()                                                   │
│  └ on_progress()                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         │ 생성
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            server_pipeline                                    │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                        업로드 처리 (클라이언트 → 서버)                 │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐              │   │
│  │  │ network  │─▶│decompress│─▶│  verify  │─▶│ io_write │              │   │
│  │  │ receive  │  │          │  │  CRC32   │  │          │              │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘              │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                        다운로드 처리 (서버 → 클라이언트)               │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐              │   │
│  │  │ io_read  │─▶│ compress │─▶│  add     │─▶│ network  │              │   │
│  │  │          │  │          │  │  CRC32   │  │   send   │              │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘              │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│                   ┌────────────────────────────────┐                        │
│                   │ typed_thread_pool<pipeline_stage>│                       │
│                   └────────────────────────────────┘                        │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         │ 사용
         ▼
┌───────────────────┬───────────────────┬───────────────────┐
│  storage_manager  │ chunk_compressor  │   tcp_transport   │
│                   │                   │                   │
│  create_file()    │  decompress()     │  listen()         │
│  list_files()     │  compress()       │  accept()         │
│  validate_name()  │  get_statistics() │  send()/receive() │
└───────────────────┴───────────────────┴───────────────────┘
```

### 클라이언트 컴포넌트

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          file_transfer_client                                 │
│                                                                              │
│  설정:                           메서드:                                      │
│  ├ compression_mode              ├ connect()                                │
│  ├ compression_level             ├ disconnect()                             │
│  ├ chunk_size                    ├ upload_file()                            │
│  ├ auto_reconnect                ├ download_file()                          │
│  ├ reconnect_policy              ├ list_files()                             │
│  └ transport_type                └ cancel() / pause() / resume()            │
│                                                                              │
│  콜백:                                                                       │
│  ├ on_progress()                                                            │
│  ├ on_complete()                                                            │
│  └ on_connection_state_changed()                                            │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         │ 생성
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            client_pipeline                                    │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                        업로드 처리 (클라이언트 → 서버)                 │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐              │   │
│  │  │ io_read  │─▶│ compress │─▶│  add     │─▶│ network  │              │   │
│  │  │          │  │          │  │  CRC32   │  │   send   │              │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘              │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                        다운로드 처리 (서버 → 클라이언트)               │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐              │   │
│  │  │ network  │─▶│decompress│─▶│  verify  │─▶│ io_write │              │   │
│  │  │ receive  │  │          │  │  CRC32   │  │          │              │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘              │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│                   ┌────────────────────────────────┐                        │
│                   │ typed_thread_pool<pipeline_stage>│                       │
│                   └────────────────────────────────┘                        │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         │ 사용
         ▼
┌────────────────────┬───────────────────┬───────────────────┐
│auto_reconnect      │ chunk_compressor  │  tcp_transport    │
│   _handler         │                   │                   │
│                    │  compress()       │  connect()        │
│ attempt_reconnect()│  decompress()     │  send()           │
│ on_reconnected()   │  get_statistics() │  receive()        │
└────────────────────┴───────────────────┴───────────────────┘
```

---

## 파이프라인 아키텍처

### 스테이지 정의

```cpp
enum class pipeline_stage : uint8_t {
    io_read,        // 파일 읽기 작업
    chunk_process,  // 청크 조립/분해
    compression,    // LZ4 압축/해제
    network,        // 네트워크 송/수신
    io_write        // 파일 쓰기 작업
};
```

### 업로드 파이프라인 흐름 (클라이언트 → 서버)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              클라이언트 측                                    │
└─────────────────────────────────────────────────────────────────────────────┘
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  io_read    │     │chunk_process│     │ compression │     │   network   │
│   stage     │────▶│    stage    │────▶│    stage    │────▶│    stage    │
│             │     │             │     │             │     │             │
│ 파일을      │     │ 청크 헤더   │     │ LZ4 압축    │     │ 서버로      │
│ 청크로 읽기 │     │ 생성        │     │ (적응형)    │     │ 전송        │
│             │     │ CRC32 추가  │     │             │     │             │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
  ┌─────────┐         ┌─────────┐         ┌─────────┐         ┌─────────┐
  │read_queue│         │chunk_queue│       │comp_queue│        │send_queue│
  │   (16)  │         │   (16)  │         │   (32)  │         │   (64)  │
  └─────────┘         └─────────┘         └─────────┘         └─────────┘

                                    │
                                    │ 네트워크 전송
                                    ▼

┌─────────────────────────────────────────────────────────────────────────────┐
│                              서버 측                                          │
└─────────────────────────────────────────────────────────────────────────────┘
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   network   │     │ compression │     │chunk_process│     │  io_write   │
│   receive   │────▶│  decompress │────▶│   verify    │────▶│   stage     │
│             │     │             │     │             │     │             │
│ 클라이언트  │     │ LZ4         │     │ CRC32 검증  │     │ 저장소에    │
│ 로부터 수신 │     │ 압축 해제   │     │             │     │ 파일 쓰기   │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

### 다운로드 파이프라인 흐름 (서버 → 클라이언트)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              서버 측                                          │
└─────────────────────────────────────────────────────────────────────────────┘
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  io_read    │     │chunk_process│     │ compression │     │   network   │
│   stage     │────▶│    stage    │────▶│    stage    │────▶│    stage    │
│             │     │             │     │             │     │             │
│ 저장소에서  │     │ 청크 헤더   │     │ LZ4 압축    │     │ 클라이언트  │
│ 파일 읽기   │     │ 생성        │     │ (적응형)    │     │ 로 전송     │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘

                                    │
                                    │ 네트워크 전송
                                    ▼

┌─────────────────────────────────────────────────────────────────────────────┐
│                              클라이언트 측                                    │
└─────────────────────────────────────────────────────────────────────────────┘
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   network   │     │ compression │     │chunk_process│     │  io_write   │
│   receive   │────▶│  decompress │────▶│   verify    │────▶│   stage     │
│             │     │             │     │             │     │             │
│ 서버로부터  │     │ LZ4         │     │ CRC32 검증  │     │ 로컬에      │
│ 수신        │     │ 압축 해제   │     │             │     │ 파일 쓰기   │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

---

## 데이터 흐름

### 청크 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                         CHUNK HEADER                             │
├──────────────────┬──────────────────────────────────────────────┤
│ transfer_id      │ 16 bytes - 전송을 식별하는 UUID              │
├──────────────────┼──────────────────────────────────────────────┤
│ file_index       │  8 bytes - 배치 내 인덱스 (다중 파일)        │
├──────────────────┼──────────────────────────────────────────────┤
│ chunk_index      │  8 bytes - 순차적 청크 번호                  │
├──────────────────┼──────────────────────────────────────────────┤
│ chunk_offset     │  8 bytes - 파일 내 바이트 오프셋             │
├──────────────────┼──────────────────────────────────────────────┤
│ original_size    │  4 bytes - 압축되지 않은 데이터 크기         │
├──────────────────┼──────────────────────────────────────────────┤
│ compressed_size  │  4 bytes - 압축된 데이터 크기                │
├──────────────────┼──────────────────────────────────────────────┤
│ checksum         │  4 bytes - 데이터의 CRC32                    │
├──────────────────┼──────────────────────────────────────────────┤
│ flags            │  1 byte  - 청크 플래그 (first/last/compressed)│
├──────────────────┼──────────────────────────────────────────────┤
│ reserved         │  3 bytes - 향후 사용                         │
├──────────────────┴──────────────────────────────────────────────┤
│                          DATA                                    │
│                  (압축된 또는 원시 바이트)                       │
└─────────────────────────────────────────────────────────────────┘

총 헤더 크기: 56 bytes
```

### 연결 상태 머신

```
                              ┌──────────────┐
                              │ disconnected │
                              └──────┬───────┘
                                     │
                                     │ connect()
                                     ▼
                              ┌──────────────┐
                     ┌────────│  connecting  │────────┐
                     │        └──────┬───────┘        │
                     │               │                │
               error │               │ connected      │ timeout
                     │               ▼                │
                     │        ┌──────────────┐        │
                     │   ┌───▶│  connected   │───┐    │
                     │   │    └──────┬───────┘   │    │
                     │   │           │           │    │
                     │   │reconnected│connection │    │
                     │   │           │ lost      │    │
                     │   │           ▼           │    │
                     │   │    ┌──────────────┐   │    │
                     │   └────│ reconnecting │───┘    │
                     │        └──────┬───────┘        │
                     │               │                │
                     │               │ max_attempts   │
                     │               │ exceeded       │
                     ▼               ▼                ▼
                    ┌──────────────────────────────────┐
                    │          disconnected            │
                    └──────────────────────────────────┘
```

### 전송 상태 머신

```
                                    ┌──────────────┐
                                    │   pending    │
                                    └──────┬───────┘
                                           │
                                           │ start()
                                           ▼
                                    ┌──────────────┐
                           ┌───────│ initializing │───────┐
                           │       └──────┬───────┘       │
                           │              │               │
                     error │              │ ready         │ error
                           │              ▼               │
                           │       ┌──────────────┐       │
                           │   ┌──▶│ transferring │──┐    │
                           │   │   └──────┬───────┘  │    │
                           │   │          │          │    │
                           │   │ resume   │ complete │    │
                           │   │          ▼          │    │
                           │   │   ┌──────────────┐  │    │
                           │   └───│  verifying   │  │    │
                           │       └──────┬───────┘  │    │
                           │              │          │    │
                           │              │ verified │    │
                           │              ▼          │    │
                           │       ┌──────────────┐  │    │
                           │       │  completed   │  │    │
                           │       └──────────────┘  │    │
                           │                         │    │
                           │    cancel()             │    │
                           ▼                         ▼    ▼
                    ┌──────────────┐          ┌──────────────┐
                    │   failed     │          │  cancelled   │
                    └──────────────┘          └──────────────┘
```

---

## 설계 패턴

### 1. Builder 패턴

다양한 옵션을 가진 복잡한 객체 구성에 사용됩니다.

```cpp
// 서버 빌더
auto server = file_transfer_server::builder()
    .with_storage_directory("/data/files")
    .with_max_connections(100)
    .with_max_file_size(10ULL * 1024 * 1024 * 1024)
    .with_storage_quota(1ULL * 1024 * 1024 * 1024 * 1024)
    .build();

// 클라이언트 빌더
auto client = file_transfer_client::builder()
    .with_compression(compression_mode::adaptive)
    .with_chunk_size(256 * 1024)
    .with_auto_reconnect(true)
    .with_transport(transport_type::tcp)
    .build();
```

### 2. Pipeline 패턴

스테이지들이 디커플링을 위한 큐를 사용하여 독립적으로 데이터를 처리합니다.

```cpp
// 각 스테이지는 스레드 풀의 타입화된 작업입니다
class compress_job : public typed_job_t<pipeline_stage::compression> {
    void execute() override {
        auto compressed = compressor_.compress(chunk_);
        output_queue_.push(std::move(compressed));
    }
};
```

### 3. Strategy 패턴

플러그인 가능한 전송 구현.

```cpp
class transport_interface {
    virtual auto send(span<const byte> data) -> Result<void> = 0;
    virtual auto receive(span<byte> buffer) -> Result<size_t> = 0;
};

class tcp_transport : public transport_interface { ... };
class quic_transport : public transport_interface { ... };
```

### 4. Observer 패턴

콜백 기반 이벤트 알림.

```cpp
// 서버 콜백
server->on_upload_request([](const upload_request& req) {
    return req.file_size < 1e9;  // 1GB 미만 수락
});

server->on_client_connected([](const client_info& info) {
    std::cout << "연결됨: " << info.address << "\n";
});

// 클라이언트 콜백
client->on_progress([](const transfer_progress& p) {
    // 진행 상황 업데이트 처리
});

client->on_connection_state_changed([](connection_state state) {
    // 연결 상태 변경 처리
});
```

### 5. Factory 패턴

전송 인스턴스 생성.

```cpp
auto transport = transport_factory::create(transport_type::tcp);
```

---

## 스레딩 모델

### 스레드 풀 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   typed_thread_pool<pipeline_stage>                          │
│                                                                              │
│  Stage: io_read                Stage: compression               Stage: network│
│  ┌─────────────┐               ┌─────────────┐                 ┌─────────────┐│
│  │  Worker 0   │               │  Worker 0   │                 │  Worker 0   ││
│  ├─────────────┤               ├─────────────┤                 ├─────────────┤│
│  │  Worker 1   │               │  Worker 1   │                 │  Worker 1   ││
│  └─────────────┘               ├─────────────┤                 └─────────────┘│
│                                │  Worker 2   │                                │
│                                ├─────────────┤                                │
│                                │  Worker 3   │                                │
│                                └─────────────┘                                │
│                                                                              │
│  작업 라우팅: 작업은 스테이지 타입에 따라 워커로 라우팅됩니다                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 동시성 모델

| 측면 | 구현 |
|------|------|
| **스테이지 간 통신** | 백프레셔가 있는 제한된 큐 |
| **스테이지 내 병렬성** | 스테이지당 다중 워커 |
| **스레드 안전성** | 가능한 경우 잠금 없는 큐 |
| **정상 종료** | 중지 전 큐 드레인 |
| **연결 처리** | 클라이언트당 전용 컨텍스트 |

---

## 메모리 관리

### 메모리 경계

메모리 사용량은 결정적이며 제한됩니다:

```
max_memory = Σ (queue_size × chunk_size) 모든 큐에 대해

기본값 (256KB 청크):
  클라이언트 업로드:   (16 + 16 + 32 + 64) × 256KB = 32MB
  클라이언트 다운로드: (64 + 32 + 16 + 16) × 256KB = 32MB
  서버 연결당:         ~64MB (양방향)
```

### 버퍼 풀링

청크 버퍼는 할당 오버헤드를 줄이기 위해 풀링됩니다:

```cpp
class chunk_buffer_pool {
    // 미리 할당된 버퍼 풀
    // 청크 간 버퍼 재사용
    // 가능한 경우 제로 카피
};
```

### 백프레셔

다운스트림이 느릴 때 업스트림이 차단됩니다:

```
빠른 읽기, 느린 네트워크:
  read_queue:     [████████████████] FULL ← Reader가 BLOCKS
  compress_queue: [████████████████████████████████] FULL
  send_queue:     [████████████████████████████████████████████████████████████████] FULL
                                                            ↑ 느린 네트워크
```

---

## 보안 고려사항

### 전송 보안

- 기본적으로 **TLS 1.3** 암호화
- 인증서 검증
- 완전 순방향 비밀성 (Forward Secrecy)

### 데이터 무결성

- 청크별 **CRC32** 무결성
- 파일별 **SHA-256** 검증
- 손상 시 자동 재전송

### 저장소 보안

- **경로 순회 방지**: 파일명에서 "../", "/", "\\" 차단
- **저장소 격리**: 모든 파일 작업이 지정된 디렉토리 내로 제한
- **파일명 검증**: 유효하지 않은 문자 차단 (`<>:"|?*`)
- **할당량 적용**: 저장소 용량 및 파일 크기 제한

### 요청 검증

서버는 콜백을 통해 모든 요청을 검증할 수 있습니다:

```cpp
server->on_upload_request([](const upload_request& req) {
    // 파일 크기 제한
    if (req.file_size > 5ULL * 1024 * 1024 * 1024) {
        return false;  // 5GB 초과 거부
    }
    // 파일 유형 검증
    if (is_blocked_extension(req.remote_name)) {
        return false;
    }
    return true;
});

server->on_download_request([](const download_request& req) {
    // 접근 제어 검증
    return has_download_permission(req.client_id, req.remote_name);
});
```

---

## 성능 목표

| 지표 | 목표 |
|------|------|
| LAN 처리량 | >= 500 MB/s |
| WAN 처리량 | >= 100 MB/s |
| LZ4 압축 | >= 400 MB/s |
| LZ4 압축 해제 | >= 1.5 GB/s |
| 메모리 기준 (클라이언트) | < 50 MB |
| 동시 클라이언트 | >= 100 |
| 재연결 시간 | < 5초 (지수 백오프) |

---

*최종 업데이트: 2025-12-11*
*버전: 2.0.0*
