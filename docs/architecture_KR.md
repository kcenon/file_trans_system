# 아키텍처 개요

이 문서는 **file_trans_system**의 아키텍처에 대한 종합적인 개요를 제공합니다. 시스템 계층, 컴포넌트 관계, 설계 패턴을 포함합니다.

## 목차

1. [시스템 개요](#시스템-개요)
2. [계층화된 아키텍처](#계층화된-아키텍처)
3. [컴포넌트 다이어그램](#컴포넌트-다이어그램)
4. [파이프라인 아키텍처](#파이프라인-아키텍처)
5. [데이터 흐름](#데이터-흐름)
6. [설계 패턴](#설계-패턴)
7. [스레딩 모델](#스레딩-모델)
8. [메모리 관리](#메모리-관리)

---

## 시스템 개요

file_trans_system은 **다단계 파이프라인 아키텍처**를 기반으로 구축된 고성능 파일 전송 라이브러리입니다. 설계 시 우선순위는 다음과 같습니다:

- **처리량**: 병렬 처리를 통한 데이터 전송 속도 극대화
- **신뢰성**: 체크섬과 검증을 통한 데이터 무결성 보장
- **재개 가능성**: 중단된 전송 복구 지원
- **확장성**: 다수의 동시 전송을 효율적으로 처리
- **메모리 효율성**: 파일 크기와 무관하게 제한된 메모리 사용

### 고수준 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              APPLICATION                                     │
│                                                                              │
│         ┌─────────────────────┐       ┌─────────────────────┐               │
│         │    file_sender      │       │   file_receiver     │               │
│         └──────────┬──────────┘       └──────────┬──────────┘               │
│                    │                             │                           │
├────────────────────┼─────────────────────────────┼───────────────────────────┤
│                    │        CORE LAYER           │                           │
│         ┌──────────▼──────────┐       ┌──────────▼──────────┐               │
│         │   sender_pipeline   │       │  receiver_pipeline  │               │
│         │                     │       │                     │               │
│         │ ┌─────┐ ┌─────┐    │       │ ┌─────┐ ┌─────┐    │               │
│         │ │Read │→│Chunk│→   │       │ │Recv │→│Decomp│→  │               │
│         │ └─────┘ └─────┘    │       │ └─────┘ └─────┘    │               │
│         │ ┌─────┐ ┌─────┐    │       │ ┌─────┐ ┌─────┐    │               │
│         │ │Comp │→│Send │    │       │ │Assem│→│Write│    │               │
│         │ └─────┘ └─────┘    │       │ └─────┘ └─────┘    │               │
│         └──────────┬──────────┘       └──────────┬──────────┘               │
│                    │                             │                           │
├────────────────────┼─────────────────────────────┼───────────────────────────┤
│                    │       SERVICE LAYER         │                           │
│    ┌───────────────┴───────────────┬─────────────┴───────────────┐          │
│    │                               │                             │          │
│    ▼                               ▼                             ▼          │
│ ┌──────────────┐           ┌──────────────┐           ┌──────────────┐      │
│ │chunk_manager │           │chunk_compressor│         │   checksum   │      │
│ │              │           │              │           │              │      │
│ │ ├ splitter   │           │ ├ lz4_engine │           │ ├ crc32      │      │
│ │ └ assembler  │           │ └ adaptive   │           │ └ sha256     │      │
│ └──────────────┘           └──────────────┘           └──────────────┘      │
│                                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                           TRANSPORT LAYER                                    │
│                                                                              │
│    ┌──────────────────────────────────────────────────────────────────┐     │
│    │                    transport_interface                            │     │
│    └─────────────────────────────┬────────────────────────────────────┘     │
│                                  │                                           │
│              ┌───────────────────┼───────────────────┐                      │
│              │                   │                   │                      │
│              ▼                   ▼                   ▼                      │
│       ┌────────────┐      ┌────────────┐      ┌────────────┐               │
│       │tcp_transport│      │quic_transport│    │   mock     │               │
│       │ (TLS 1.3)  │      │  (Phase 2) │      │ (testing)  │               │
│       └────────────┘      └────────────┘      └────────────┘               │
│                                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                          INFRASTRUCTURE LAYER                                │
│                                                                              │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │common_system│  │thread_system│ │network_system│ │container_  │            │
│  │            │  │            │  │            │  │   system   │            │
│  │ Result<T>  │  │typed_thread │  │   socket   │  │  bounded   │            │
│  │ error      │  │   _pool    │  │   buffer   │  │   queue    │            │
│  │ time       │  │ job_queue  │  │            │  │            │            │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘            │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 계층화된 아키텍처

### 계층 1: API 계층

**API 계층**은 애플리케이션을 위한 공개 인터페이스를 제공합니다.

| 클래스 | 목적 | 주요 메서드 |
|-------|------|------------|
| `file_sender` | 원격 엔드포인트로 파일 전송 | `send_file()`, `send_files()`, `cancel()`, `pause()`, `resume()` |
| `file_receiver` | 원격 송신자로부터 파일 수신 | `start()`, `stop()`, `set_output_directory()` |
| `transfer_manager` | 동시 전송 관리 | `get_status()`, `list_transfers()`, `get_statistics()` |

**설계 원칙**: 유연한 설정을 위한 Builder 패턴, 콜백 기반 이벤트 처리.

### 계층 2: Core 계층

**Core 계층**은 파이프라인 처리 로직을 구현합니다.

| 컴포넌트 | 목적 |
|---------|------|
| `sender_pipeline` | 파일 읽기, 압축, 전송 조율 |
| `receiver_pipeline` | 수신, 압축 해제, 쓰기 조율 |

**설계 원칙**: 제한된 큐를 사용한 스테이지 기반 병렬 처리.

### 계층 3: Service 계층

**Service 계층**은 재사용 가능한 처리 컴포넌트를 제공합니다.

| 컴포넌트 | 목적 |
|---------|------|
| `chunk_splitter` | 파일을 청크로 분할 |
| `chunk_assembler` | 청크를 파일로 재조립 |
| `chunk_compressor` | 청크 압축/압축 해제 |
| `lz4_engine` | 저수준 LZ4 연산 |
| `adaptive_compression` | 압축 가능성 감지 |
| `checksum` | CRC32 및 SHA-256 연산 |

**설계 원칙**: 단일 책임, 가능한 경우 무상태.

### 계층 4: Transport 계층

**Transport 계층**은 네트워크 통신을 추상화하며 **network_system**을 사용하여 구현됩니다.

| 컴포넌트 | 목적 |
|---------|------|
| `transport_interface` | 추상 전송 API |
| `tcp_transport` | TCP + TLS 1.3 구현 **(network_system 사용)** |
| `quic_transport` | QUIC 구현 **(network_system, Phase 2)** |
| `transport_factory` | 전송 생성을 위한 팩토리 |

**설계 원칙**: 플러그인 가능한 전송을 위한 Strategy 패턴.

> **참고**: TCP와 QUIC 전송 모두 **network_system**에서 제공됩니다. 외부 전송 라이브러리가 필요하지 않습니다. 이를 통해 모든 전송 유형에서 일관된 동작과 최적의 성능을 보장합니다.

### 계층 5: Infrastructure 계층

**Infrastructure 계층**은 kcenon 생태계의 기반 유틸리티를 제공합니다.

| 시스템 | 사용되는 컴포넌트 |
|--------|-----------------|
| common_system | `Result<T>`, 오류 코드, 시간 유틸리티 |
| thread_system | 병렬 파이프라인 처리를 위한 `typed_thread_pool<pipeline_stage>` |
| **network_system** | **TCP/TLS 전송, QUIC 전송, 소켓 관리, 버퍼** |
| container_system | 백프레셔를 위한 `bounded_queue<T>` |

> **중요**: 전체 전송 계층은 프로덕션 수준의 TCP(TLS 1.3 포함) 및 QUIC 구현을 제공하는 **network_system**을 기반으로 구축됩니다.

---

## 컴포넌트 다이어그램

### 송신자 컴포넌트

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              file_sender                                     │
│                                                                              │
│  설정:                           메서드:                                      │
│  ├ compression_mode               ├ send_file()                             │
│  ├ compression_level              ├ send_files()                            │
│  ├ chunk_size                     ├ cancel()                                │
│  ├ bandwidth_limit                ├ pause()                                 │
│  └ transport_type                 ├ resume()                                │
│                                   └ on_progress()                           │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         │ 생성
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            sender_pipeline                                   │
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │   io_read    │  │chunk_process │  │ compression  │  │   network    │    │
│  │    stage     │──│    stage     │──│    stage     │──│    stage     │    │
│  │              │  │              │  │              │  │              │    │
│  │ Workers: 2   │  │ Workers: 2   │  │ Workers: 4   │  │ Workers: 2   │    │
│  │ Queue: 16    │  │ Queue: 16    │  │ Queue: 32    │  │ Queue: 64    │    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
│         │                 │                 │                 │             │
│         └─────────────────┴─────────────────┴─────────────────┘             │
│                                     │                                        │
│                                     ▼                                        │
│                    ┌────────────────────────────────┐                       │
│                    │ typed_thread_pool<pipeline_stage>│                      │
│                    └────────────────────────────────┘                       │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         │ 사용
         ▼
┌───────────────────┬───────────────────┬───────────────────┐
│  chunk_splitter   │ chunk_compressor  │ tcp_transport     │
│                   │                   │                   │
│  split()          │  compress()       │  connect()        │
│  calculate_       │  get_statistics() │  send()           │
│    metadata()     │                   │  receive()        │
└───────────────────┴───────────────────┴───────────────────┘
```

### 수신자 컴포넌트

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            file_receiver                                     │
│                                                                              │
│  설정:                           콜백:                                        │
│  ├ output_directory               ├ on_transfer_request()                   │
│  ├ bandwidth_limit                ├ on_progress()                           │
│  └ transport_type                 └ on_complete()                           │
│                                                                              │
│  메서드:                                                                      │
│  ├ start()                                                                   │
│  └ stop()                                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         │ 생성
         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          receiver_pipeline                                   │
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │   network    │  │ compression  │  │chunk_process │  │  io_write    │    │
│  │   receive    │──│  decompress  │──│   assemble   │──│    stage     │    │
│  │              │  │              │  │              │  │              │    │
│  │ Workers: 2   │  │ Workers: 4   │  │ Workers: 2   │  │ Workers: 2   │    │
│  │ Queue: 64    │  │ Queue: 32    │  │ Queue: 16    │  │ Queue: 16    │    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
│         │                 │                 │                 │             │
│         └─────────────────┴─────────────────┴─────────────────┘             │
│                                     │                                        │
│                                     ▼                                        │
│                    ┌────────────────────────────────┐                       │
│                    │ typed_thread_pool<pipeline_stage>│                      │
│                    └────────────────────────────────┘                       │
└─────────────────────────────────────────────────────────────────────────────┘
         │
         │ 사용
         ▼
┌───────────────────┬───────────────────┬───────────────────┐
│ chunk_assembler   │ chunk_compressor  │ tcp_transport     │
│                   │                   │                   │
│  process_chunk()  │  decompress()     │  listen()         │
│  is_complete()    │  get_statistics() │  accept()         │
│  finalize()       │                   │  receive()        │
└───────────────────┴───────────────────┴───────────────────┘
```

---

## 파이프라인 아키텍처

### 스테이지 정의

```cpp
enum class pipeline_stage : uint8_t {
    io_read,        // 파일 읽기 작업
    chunk_process,  // 청크 조립/분해
    compression,    // LZ4 압축/해제
    network,        // 네트워크 송/수신
    io_write        // 파일 쓰기 작업
};
```

### 송신자 파이프라인 흐름

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  io_read    │     │chunk_process│     │ compression │     │   network   │
│   stage     │────▶│    stage    │────▶│    stage    │────▶│    stage    │
│             │     │             │     │             │     │             │
│ 파일을      │     │ 청크 헤더   │     │ LZ4 압축    │     │ 전송 계층   │
│ 청크로 읽기 │     │ 생성        │     │ (적응형)    │     │ 으로 전송   │
│             │     │ CRC32 추가  │     │             │     │             │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
  ┌─────────┐         ┌─────────┐         ┌─────────┐         ┌─────────┐
  │read_queue│         │chunk_queue│       │comp_queue│        │send_queue│
  │   (16)  │         │   (16)  │         │   (32)  │         │   (64)  │
  └─────────┘         └─────────┘         └─────────┘         └─────────┘
```

### 수신자 파이프라인 흐름

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   network   │     │ compression │     │chunk_process│     │  io_write   │
│   receive   │────▶│  decompress │────▶│   assemble  │────▶│   stage     │
│             │     │             │     │             │     │             │
│ 전송 계층   │     │ LZ4         │     │ CRC32 검증  │     │ 올바른      │
│ 으로부터    │     │ 압축 해제   │     │ 순서 처리   │     │ 오프셋에    │
│ 수신        │     │             │     │             │     │ 파일 쓰기   │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
  ┌─────────┐         ┌─────────┐         ┌─────────┐         ┌─────────┐
  │recv_queue│        │decomp_queue│       │assem_queue│       │write_queue│
  │   (64)  │         │   (32)  │         │   (16)  │         │   (16)  │
  └─────────┘         └─────────┘         └─────────┘         └─────────┘
```

---

## 데이터 흐름

### 청크 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                         CHUNK HEADER                             │
├──────────────────┬──────────────────────────────────────────────┤
│ transfer_id      │ 16 bytes - 전송을 식별하는 UUID              │
├──────────────────┼──────────────────────────────────────────────┤
│ file_index       │  8 bytes - 배치 내 인덱스 (다중 파일)        │
├──────────────────┼──────────────────────────────────────────────┤
│ chunk_index      │  8 bytes - 순차적 청크 번호                  │
├──────────────────┼──────────────────────────────────────────────┤
│ chunk_offset     │  8 bytes - 파일 내 바이트 오프셋             │
├──────────────────┼──────────────────────────────────────────────┤
│ original_size    │  4 bytes - 압축되지 않은 데이터 크기         │
├──────────────────┼──────────────────────────────────────────────┤
│ compressed_size  │  4 bytes - 압축된 데이터 크기                │
├──────────────────┼──────────────────────────────────────────────┤
│ checksum         │  4 bytes - 데이터의 CRC32                    │
├──────────────────┼──────────────────────────────────────────────┤
│ flags            │  1 byte  - 청크 플래그 (first/last/compressed)│
├──────────────────┼──────────────────────────────────────────────┤
│ reserved         │  3 bytes - 향후 사용                         │
├──────────────────┴──────────────────────────────────────────────┤
│                          DATA                                    │
│                  (압축된 또는 원시 바이트)                       │
└─────────────────────────────────────────────────────────────────┘
```

### 전송 상태 머신

```
                                    ┌──────────────┐
                                    │   pending    │
                                    └──────┬───────┘
                                           │
                                           │ start()
                                           ▼
                                    ┌──────────────┐
                           ┌───────│ initializing │───────┐
                           │       └──────┬───────┘       │
                           │              │               │
                     error │              │ connected     │ error
                           │              ▼               │
                           │       ┌──────────────┐       │
                           │   ┌──▶│ transferring │──┐    │
                           │   │   └──────┬───────┘  │    │
                           │   │          │          │    │
                           │   │ resume   │ complete │    │
                           │   │          ▼          │    │
                           │   │   ┌──────────────┐  │    │
                           │   └───│  verifying   │  │    │
                           │       └──────┬───────┘  │    │
                           │              │          │    │
                           │              │ verified │    │
                           │              ▼          │    │
                           │       ┌──────────────┐  │    │
                           │       │  completed   │  │    │
                           │       └──────────────┘  │    │
                           │                         │    │
                           │    cancel()             │    │
                           ▼                         ▼    ▼
                    ┌──────────────┐          ┌──────────────┐
                    │   failed     │          │  cancelled   │
                    └──────────────┘          └──────────────┘
```

---

## 설계 패턴

### 1. Builder 패턴

다양한 옵션을 가진 복잡한 객체 구성에 사용됩니다.

```cpp
auto sender = file_sender::builder()
    .with_compression(compression_mode::adaptive)
    .with_chunk_size(256 * 1024)
    .with_bandwidth_limit(10 * 1024 * 1024)
    .with_transport(transport_type::tcp)
    .build();
```

### 2. Pipeline 패턴

스테이지들이 디커플링을 위한 큐를 사용하여 독립적으로 데이터를 처리합니다.

```cpp
// 각 스테이지는 스레드 풀의 타입화된 작업입니다
class compress_job : public typed_job_t<pipeline_stage::compression> {
    void execute() override {
        auto compressed = compressor_.compress(chunk_);
        output_queue_.push(std::move(compressed));
    }
};
```

### 3. Strategy 패턴

플러그인 가능한 전송 구현.

```cpp
class transport_interface {
    virtual auto send(span<const byte> data) -> Result<void> = 0;
    virtual auto receive(span<byte> buffer) -> Result<size_t> = 0;
};

class tcp_transport : public transport_interface { ... };
class quic_transport : public transport_interface { ... };
```

### 4. Observer 패턴

콜백 기반 이벤트 알림.

```cpp
sender->on_progress([](const transfer_progress& p) {
    // 진행 상황 업데이트 처리
});

receiver->on_complete([](const transfer_result& result) {
    // 완료 처리
});
```

### 5. Factory 패턴

전송 인스턴스 생성.

```cpp
auto transport = transport_factory::create(transport_type::tcp);
```

---

## 스레딩 모델

### 스레드 풀 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   typed_thread_pool<pipeline_stage>                          │
│                                                                              │
│  Stage: io_read                Stage: compression               Stage: network│
│  ┌─────────────┐               ┌─────────────┐                 ┌─────────────┐│
│  │  Worker 0   │               │  Worker 0   │                 │  Worker 0   ││
│  ├─────────────┤               ├─────────────┤                 ├─────────────┤│
│  │  Worker 1   │               │  Worker 1   │                 │  Worker 1   ││
│  └─────────────┘               ├─────────────┤                 └─────────────┘│
│                                │  Worker 2   │                                │
│                                ├─────────────┤                                │
│                                │  Worker 3   │                                │
│                                └─────────────┘                                │
│                                                                              │
│  작업 라우팅: 작업은 스테이지 타입에 따라 워커로 라우팅됩니다                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 동시성 모델

| 측면 | 구현 |
|------|------|
| **스테이지 간 통신** | 백프레셔가 있는 제한된 큐 |
| **스테이지 내 병렬성** | 스테이지당 다중 워커 |
| **스레드 안전성** | 가능한 경우 잠금 없는 큐 |
| **정상 종료** | 중지 전 큐 드레인 |

---

## 메모리 관리

### 메모리 경계

메모리 사용량은 결정적이며 제한됩니다:

```
max_memory = Σ (queue_size × chunk_size) 모든 큐에 대해

기본값 (256KB 청크):
  송신자:   (16 + 16 + 32 + 64) × 256KB = 32MB
  수신자:   (64 + 32 + 16 + 16) × 256KB = 32MB
  총합:     최대 64MB
```

### 버퍼 풀링

청크 버퍼는 할당 오버헤드를 줄이기 위해 풀링됩니다:

```cpp
class chunk_buffer_pool {
    // 미리 할당된 버퍼 풀
    // 청크 간 버퍼 재사용
    // 가능한 경우 제로 카피
};
```

### 백프레셔

다운스트림이 느릴 때 업스트림이 차단됩니다:

```
빠른 읽기, 느린 네트워크:
  read_queue:     [████████████████] FULL ← Reader가 BLOCKS
  compress_queue: [████████████████████████████████] FULL
  send_queue:     [████████████████████████████████████████████████████████████████] FULL
                                                            ↑ 느린 네트워크
```

---

## 보안 고려사항

### 전송 보안

- 기본적으로 **TLS 1.3** 암호화
- 인증서 검증
- 완전 순방향 비밀성

### 데이터 무결성

- 청크별 **CRC32** 무결성
- 파일별 **SHA-256** 검증
- 손상 시 자동 재전송

### 경로 안전성

- 경로 순회 방지
- 출력 디렉토리 검증
- 임의 파일 덮어쓰기 방지

---

*최종 업데이트: 2025-12-11*
