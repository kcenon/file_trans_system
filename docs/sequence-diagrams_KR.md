# 시퀀스 다이어그램

**file_trans_system**의 주요 동작 흐름을 설명하는 시퀀스 다이어그램 모음입니다.

## 목차

1. [핸드셰이크 및 세션 설정](#핸드셰이크-및-세션-설정)
2. [단일 파일 전송](#단일-파일-전송)
3. [청크 처리 (송신자)](#청크-처리-송신자)
4. [청크 처리 (수신자)](#청크-처리-수신자)
5. [오류 복구](#오류-복구)
6. [전송 재개](#전송-재개)
7. [배치 전송](#배치-전송)
8. [전송 취소](#전송-취소)

---

## 핸드셰이크 및 세션 설정

```
    송신자                                  수신자
      │                                       │
      │────── HANDSHAKE_REQUEST ─────────────▶│
      │       (protocol_version,              │
      │        capabilities,                  │
      │        client_id)                     │
      │                                       │
      │                              ┌────────┴────────┐
      │                              │ 버전 확인       │
      │                              │ 기능 협상       │
      │                              │ 세션 ID 생성    │
      │                              └────────┬────────┘
      │                                       │
      │◀───── HANDSHAKE_RESPONSE ────────────│
      │       (agreed_version,                │
      │        negotiated_capabilities,       │
      │        session_id,                    │
      │        max_chunk_size,                │
      │        max_concurrent)                │
      │                                       │
┌─────┴─────┐                                 │
│ 세션 저장 │                                 │
└─────┬─────┘                                 │
      │                                       │
      │ ═══════════════════════════════════ │
      │         세션 수립 완료                 │
      │ ═══════════════════════════════════ │
```

### 기능 협상

협상되는 기능:

| 비트 | 기능 | 설명 |
|-----|------|------|
| 0 | 압축 지원 | LZ4 압축 가능 여부 |
| 1 | 재개 지원 | 중단된 전송 재개 가능 여부 |
| 2 | 배치 전송 | 다중 파일 전송 지원 여부 |
| 3 | QUIC 지원 | QUIC 프로토콜 사용 가능 여부 |

---

## 단일 파일 전송

```
    송신자                                  수신자
      │                                       │
      │────── TRANSFER_REQUEST ──────────────▶│
      │       (transfer_id,                   │
      │        file_metadata[],               │
      │        compression_mode,              │
      │        options)                       │
      │                                       │
      │                              ┌────────┴────────┐
      │                              │ 파일 메타데이터 │
      │                              │ 검증            │
      │                              │ 디스크 공간     │
      │                              │ 확인            │
      │                              │ 수락/거부 결정  │
      │                              └────────┬────────┘
      │                                       │
      │◀───── TRANSFER_ACCEPT ───────────────│
      │       (transfer_id,                   │
      │        accepted_compression,          │
      │        chunk_size)                    │
      │                                       │
┌─────┴─────┐                                 │
│ 파이프    │                                 │
│ 라인 시작 │                                 │
└─────┬─────┘                                 │
      │                                       │
      │────── CHUNK_DATA (청크 0) ───────────▶│
      │       (header + compressed_data)      │
      │                                       │
      │◀───── CHUNK_ACK (청크 0) ────────────│
      │                                       │
      │────── CHUNK_DATA (청크 1) ───────────▶│
      │                                       │
      │◀───── CHUNK_ACK (청크 1) ────────────│
      │                                       │
      │            ... 청크 반복 ...           │
      │                                       │
      │────── CHUNK_DATA (마지막, flags=0x02)▶│
      │                                       │
      │◀───── CHUNK_ACK ─────────────────────│
      │                                       │
      │────── TRANSFER_COMPLETE ─────────────▶│
      │       (bytes_sent,                    │
      │        bytes_on_wire)                 │
      │                                       │
      │                              ┌────────┴────────┐
      │                              │ SHA-256 검증    │
      │                              └────────┬────────┘
      │                                       │
      │◀───── TRANSFER_VERIFY ───────────────│
      │       (verified: true/false,          │
      │        computed_hash)                 │
      │                                       │
      │ ═══════════════════════════════════ │
      │           전송 완료                   │
      │ ═══════════════════════════════════ │
```

---

## 청크 처리 (송신자)

```
    애플리케이션     file_sender    sender_pipeline   io_read    compression   network
         │               │               │             │              │           │
         │─send_file()──▶│               │             │              │           │
         │               │               │             │              │           │
         │               │──submit()────▶│             │              │           │
         │               │               │             │              │           │
         │               │               │──read_chunk()│             │           │
         │               │               │◀────────────│             │           │
         │               │               │             │              │           │
         │               │               │──────────────────────────▶│           │
         │               │               │             compress()    │           │
         │               │               │◀──────────────────────────│           │
         │               │               │             │              │           │
         │               │               │──────────────────────────────────────▶│
         │               │               │             │              │  send()  │
         │               │               │◀──────────────────────────────────────│
         │               │               │             │              │           │
         │               │               │        (다음 청크 반복)               │
         │               │               │             │              │           │
         │◀──handle─────│               │             │              │           │
         │               │               │             │              │           │
```

### 파이프라인 스테이지 상세

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           송신자 파이프라인                                   │
│                                                                              │
│   ┌───────────┐     ┌───────────┐     ┌───────────┐     ┌───────────┐      │
│   │  io_read  │     │  chunk    │     │compression│     │  network  │      │
│   │  stage    │────▶│  process  │────▶│  stage    │────▶│  stage    │      │
│   └───────────┘     └───────────┘     └───────────┘     └───────────┘      │
│        │                 │                 │                 │              │
│        │                 │                 │                 │              │
│   ┌────▼────┐       ┌────▼────┐       ┌────▼────┐       ┌────▼────┐        │
│   │read_queue│       │chunk_queue│     │comp_queue│      │send_queue│        │
│   │  (16)   │       │  (16)   │       │  (32)   │       │  (64)   │        │
│   └─────────┘       └─────────┘       └─────────┘       └─────────┘        │
│                                                                              │
│   워커: 2             워커: 2          워커: 4           워커: 2             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 청크 처리 (수신자)

```
    network    compression   chunk_assembler   io_write   file_receiver   애플리케이션
        │            │              │              │             │              │
        │            │              │              │             │              │
  ◀─recv()│          │              │              │             │              │
        │            │              │              │             │              │
        │─────▶decompress()        │              │             │              │
        │◀───────────│              │              │             │              │
        │            │              │              │             │              │
        │            │──process_chunk()│           │             │              │
        │            │              │──────────────▶             │              │
        │            │◀─────────────│              │             │              │
        │            │              │              │             │              │
        │            │              │              │──write()    │              │
        │            │              │              │             │              │
        │            │              │              │             │              │
        │            │              │        (마지막 청크)       │              │
        │            │              │              │             │              │
        │            │              │              │──finalize()─│              │
        │            │              │              │             │              │
        │            │              │              │             │──on_complete()
        │            │              │              │             │──────────────▶
```

### 수신자 파이프라인 상세

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           수신자 파이프라인                                   │
│                                                                              │
│   ┌───────────┐     ┌───────────┐     ┌───────────┐     ┌───────────┐      │
│   │  network  │     │ decompress│     │  chunk    │     │ io_write  │      │
│   │  receive  │────▶│  stage    │────▶│ assemble  │────▶│  stage    │      │
│   └───────────┘     └───────────┘     └───────────┘     └───────────┘      │
│        │                 │                 │                 │              │
│        │                 │                 │                 │              │
│   ┌────▼────┐       ┌────▼────┐       ┌────▼────┐       ┌────▼────┐        │
│   │recv_queue│      │decomp_queue│    │assem_queue│      │write_queue│       │
│   │  (64)   │       │  (32)   │       │  (16)   │       │  (16)   │        │
│   └─────────┘       └─────────┘       └─────────┘       └─────────┘        │
│                                                                              │
│   워커: 2             워커: 4          워커: 2           워커: 2             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 오류 복구

### 청크 체크섬 실패

```
    송신자                                  수신자
      │                                       │
      │────── CHUNK_DATA (청크 5) ───────────▶│
      │       (손상된 데이터)                  │
      │                                       │
      │                              ┌────────┴────────┐
      │                              │ CRC32 검증 실패 │
      │                              └────────┬────────┘
      │                                       │
      │◀───── CHUNK_NACK (청크 5) ───────────│
      │       (reason: checksum_error)        │
      │                                       │
┌─────┴─────┐                                 │
│ 청크 5    │                                 │
│ 재전송    │                                 │
└─────┬─────┘                                 │
      │                                       │
      │────── CHUNK_DATA (청크 5, 재시도) ───▶│
      │                                       │
      │                              ┌────────┴────────┐
      │                              │ CRC32 검증 성공 │
      │                              └────────┬────────┘
      │                                       │
      │◀───── CHUNK_ACK (청크 5) ────────────│
      │                                       │
```

### 압축 해제 실패

```
    송신자                                  수신자
      │                                       │
      │────── CHUNK_DATA (청크 N) ───────────▶│
      │       (압축된 데이터 손상)             │
      │                                       │
      │                              ┌────────┴────────┐
      │                              │ LZ4 압축 해제   │
      │                              │ 실패            │
      │                              └────────┬────────┘
      │                                       │
      │◀───── CHUNK_NACK (청크 N) ───────────│
      │       (reason: decompression_failed)  │
      │                                       │
┌─────┴─────┐                                 │
│ 비압축    │                                 │
│ 으로     │                                 │
│ 폴백     │                                 │
└─────┬─────┘                                 │
      │                                       │
      │────── CHUNK_DATA (청크 N) ───────────▶│
      │       (비압축, flags 없음)            │
      │                                       │
      │◀───── CHUNK_ACK (청크 N) ────────────│
      │                                       │
```

---

## 전송 재개

```
    송신자                                  수신자
      │                                       │
      │  (이전 전송이 청크 50에서 중단됨)      │
      │                                       │
      │────── HANDSHAKE_REQUEST ─────────────▶│
      │◀───── HANDSHAKE_RESPONSE ────────────│
      │                                       │
      │────── RESUME_REQUEST ────────────────▶│
      │       (transfer_id,                   │
      │        chunk_bitmap)                  │
      │                                       │
      │                              ┌────────┴────────┐
      │                              │ 저장된 상태와   │
      │                              │ 비트맵 비교     │
      │                              │ 누락 청크 결정  │
      │                              └────────┬────────┘
      │                                       │
      │◀───── RESUME_RESPONSE ───────────────│
      │       (can_resume: true,              │
      │        missing_chunks: [50,51,52...]) │
      │                                       │
┌─────┴─────┐                                 │
│ 청크 50   │                                 │
│ 부터 시작 │                                 │
└─────┬─────┘                                 │
      │                                       │
      │────── CHUNK_DATA (청크 50) ──────────▶│
      │◀───── CHUNK_ACK ─────────────────────│
      │                                       │
      │────── CHUNK_DATA (청크 51) ──────────▶│
      │◀───── CHUNK_ACK ─────────────────────│
      │                                       │
      │            ... 남은 청크 ...           │
      │                                       │
      │────── TRANSFER_COMPLETE ─────────────▶│
      │◀───── TRANSFER_VERIFY ───────────────│
      │                                       │
```

### 재개 상태 관리

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           재개 상태 파일                                     │
│                                                                              │
│   transfer_id:     "550e8400-e29b-41d4-a716-446655440000"                   │
│   file_path:       "/path/to/large_file.dat"                                │
│   file_hash:       "sha256:abc123..."                                       │
│   total_chunks:    1000                                                     │
│   received_chunks: [0,1,2,...,49]  (비트맵)                                 │
│   last_modified:   "2024-01-15T10:30:00Z"                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 배치 전송

```
    송신자                                  수신자
      │                                       │
      │────── TRANSFER_REQUEST ──────────────▶│
      │       (transfer_id,                   │
      │        file_count: 3,                 │
      │        files: [                       │
      │          {name: "a.txt", size: 1MB},  │
      │          {name: "b.txt", size: 2MB},  │
      │          {name: "c.txt", size: 3MB}   │
      │        ])                             │
      │                                       │
      │◀───── TRANSFER_ACCEPT ───────────────│
      │                                       │
      │ ═════════════ 파일 1 ═══════════════ │
      │                                       │
      │────── CHUNK_DATA (file:0, chunk:0) ──▶│
      │◀───── CHUNK_ACK ─────────────────────│
      │              ... 파일 1 청크들 ...    │
      │                                       │
      │ ═════════════ 파일 2 ═══════════════ │
      │                                       │
      │────── CHUNK_DATA (file:1, chunk:0) ──▶│
      │◀───── CHUNK_ACK ─────────────────────│
      │              ... 파일 2 청크들 ...    │
      │                                       │
      │ ═════════════ 파일 3 ═══════════════ │
      │                                       │
      │────── CHUNK_DATA (file:2, chunk:0) ──▶│
      │◀───── CHUNK_ACK ─────────────────────│
      │              ... 파일 3 청크들 ...    │
      │                                       │
      │────── TRANSFER_COMPLETE ─────────────▶│
      │       (모든 파일)                     │
      │                                       │
      │◀───── TRANSFER_VERIFY ───────────────│
      │       (file_results: [               │
      │         {file:0, verified:true},      │
      │         {file:1, verified:true},      │
      │         {file:2, verified:true}       │
      │       ])                              │
      │                                       │
```

---

## 전송 취소

### 송신자 시작 취소

```
    애플리케이션     송신자                     수신자
         │            │                          │
         │            │──── CHUNK_DATA ─────────▶│
         │            │◀─── CHUNK_ACK ──────────│
         │            │                          │
         │──cancel()─▶│                          │
         │            │                          │
         │            │──── TRANSFER_CANCEL ────▶│
         │            │     (reason: user_cancel)│
         │            │                          │
         │            │                ┌─────────┴─────────┐
         │            │                │ 부분 파일 정리    │
         │            │                │ 리소스 해제       │
         │            │                └─────────┬─────────┘
         │            │                          │
         │            │◀─── TRANSFER_CANCEL_ACK─│
         │            │                          │
         │◀──done────│                          │
         │            │                          │
```

### 수신자 시작 취소 (거부)

```
    송신자                                  수신자
      │                                       │
      │────── TRANSFER_REQUEST ──────────────▶│
      │                                       │
      │                              ┌────────┴────────┐
      │                              │ 수락 정책 확인  │
      │                              │ 결과: 거부      │
      │                              └────────┬────────┘
      │                                       │
      │◀───── TRANSFER_REJECT ───────────────│
      │       (reason: policy_violation,      │
      │        message: "파일이 너무 큼")     │
      │                                       │
┌─────┴─────┐                                 │
│ 오류 처리 │                                 │
│ 콜백 호출 │                                 │
└───────────┘                                 │
```

---

## 연결 유지 (Keepalive)

```
    송신자                                  수신자
      │                                       │
      │  (유휴 기간 중)                        │
      │                                       │
      │────── KEEPALIVE ─────────────────────▶│
      │       (timestamp)                     │
      │                                       │
      │◀───── KEEPALIVE ─────────────────────│
      │       (timestamp)                     │
      │                                       │
      │  (연결 상태 유지)                      │
      │                                       │
```

### 타임아웃 처리

```
    송신자                                  수신자
      │                                       │
      │────── CHUNK_DATA ────────────────────▶│
      │                                       │
      │  (ACK 없음 - 타임아웃)                 │
      │                                       │
┌─────┴─────┐                                 │
│ 30초 대기 │                                 │
└─────┬─────┘                                 │
      │                                       │
      │────── CHUNK_DATA (재시도 1) ─────────▶│
      │                                       │
      │  (ACK 없음 - 타임아웃)                 │
      │                                       │
┌─────┴─────┐                                 │
│ 60초 대기 │                                 │
│(지수 백오프)│                                │
└─────┬─────┘                                 │
      │                                       │
      │────── CHUNK_DATA (재시도 2) ─────────▶│
      │                                       │
      │  (ACK 없음 - 최대 재시도 초과)         │
      │                                       │
┌─────┴─────┐                                 │
│전송 실패  │                                 │
│재개 가능  │                                 │
└───────────┘                                 │
```

---

*최종 업데이트: 2025-12-11*
