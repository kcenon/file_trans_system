# 시퀀스 다이어그램

**file_trans_system**의 주요 동작 흐름을 설명하는 시퀀스 다이어그램 모음입니다.

**버전:** 0.2.0
**아키텍처:** 클라이언트-서버 모델

---

## 목차

1. [연결 흐름](#연결-흐름)
2. [업로드 흐름](#업로드-흐름)
3. [다운로드 흐름](#다운로드-흐름)
4. [파일 목록 조회](#파일-목록-조회)
5. [자동 재연결](#자동-재연결)
6. [전송 재개](#전송-재개)
7. [청크 전송](#청크-전송)
8. [오류 처리](#오류-처리)
9. [파이프라인 처리](#파이프라인-처리)

---

## 연결 흐름

### 클라이언트의 서버 연결

```
┌────────┐          ┌────────────┐          ┌────────────┐
│클라이언트│          │  네트워크   │          │   서버     │
│  앱     │          │    계층     │          │            │
└───┬────┘          └─────┬──────┘          └─────┬──────┘
    │                     │                       │
    │  connect(endpoint)  │                       │
    │────────────────────▶│                       │
    │                     │                       │
    │                     │  TCP/TLS 연결         │
    │                     │──────────────────────▶│
    │                     │                       │
    │                     │  연결 수락            │
    │                     │◀──────────────────────│
    │                     │                       │
    │                     │  CONNECT              │
    │                     │  ┌────────────────────────────────┐
    │                     │  │ protocol_version: 0x0200      │
    │                     │  │ capabilities: 0x0000001F      │
    │                     │  │ client_id: <16 bytes UUID>    │
    │                     │  └────────────────────────────────┘
    │                     │──────────────────────▶│
    │                     │                       │
    │                     │                       │ 프로토콜
    │                     │                       │ 버전 검증
    │                     │                       │─────┐
    │                     │                       │     │
    │                     │                       │◀────┘
    │                     │                       │
    │                     │  CONNECT_ACK          │
    │                     │  ┌────────────────────────────────┐
    │                     │  │ protocol_version: 0x0200      │
    │                     │  │ capabilities: 0x0000001F      │
    │                     │  │ session_id: <16 bytes UUID>   │
    │                     │  │ max_file_size: 10GB           │
    │                     │  │ max_chunk_size: 1MB           │
    │                     │  └────────────────────────────────┘
    │                     │◀──────────────────────│
    │                     │                       │
    │  on_connected()     │                       │
    │◀────────────────────│                       │
    │                     │                       │
    │  Result<server_info>│                       │ on_client_connected()
    │◀────────────────────│                       │
    │                     │                       │
    │  연결 설정 완료                              │
    │                     │                       │
    ▼                     ▼                       ▼
```

### 클라이언트 연결 해제

```
┌────────┐          ┌────────────┐          ┌────────────┐
│클라이언트│          │  네트워크   │          │   서버     │
└───┬────┘          └─────┬──────┘          └─────┬──────┘
    │                     │                       │
    │  disconnect()       │                       │
    │────────────────────▶│                       │
    │                     │                       │
    │                     │  활성 전송 완료       │
    │                     │  대기 중              │
    │                     │─────┐                 │
    │                     │     │                 │
    │                     │◀────┘                 │
    │                     │                       │
    │                     │  DISCONNECT           │
    │                     │  ┌────────────────────────────────┐
    │                     │  │ reason: client_initiated      │
    │                     │  └────────────────────────────────┘
    │                     │──────────────────────▶│
    │                     │                       │
    │                     │                       │ on_client_disconnected()
    │                     │                       │
    │                     │  연결 닫기            │
    │                     │◀──────────────────────│
    │                     │                       │
    │  on_disconnected()  │                       │
    │◀────────────────────│                       │
    │                     │                       │
    ▼                     ▼                       ▼
```

---

## 업로드 흐름

### 완전한 업로드 (클라이언트 → 서버)

```
┌────────┐          ┌────────────┐          ┌────────────┐          ┌────────┐
│클라이언트│          │ 클라이언트  │          │   서버     │          │  서버  │
│  앱     │          │ 파이프라인  │          │ 파이프라인  │          │  앱    │
└───┬────┘          └─────┬──────┘          └─────┬──────┘          └───┬────┘
    │                     │                       │                     │
    │  upload_file(local, remote)                 │                     │
    │────────────────────▶│                       │                     │
    │                     │                       │                     │
    │                     │  UPLOAD_REQUEST       │                     │
    │                     │  ┌──────────────────────────────────────┐   │
    │                     │  │ filename: "report.pdf"              │   │
    │                     │  │ file_size: 104857600                │   │
    │                     │  │ file_hash: <sha256>                 │   │
    │                     │  │ chunk_count: 400                    │   │
    │                     │  │ chunk_size: 262144                  │   │
    │                     │  │ compression: adaptive               │   │
    │                     │  └──────────────────────────────────────┘   │
    │                     │──────────────────────▶│                     │
    │                     │                       │                     │
    │                     │                       │  on_upload_request()│
    │                     │                       │────────────────────▶│
    │                     │                       │                     │
    │                     │                       │  return true (수락) │
    │                     │                       │◀────────────────────│
    │                     │                       │                     │
    │                     │                       │  임시 파일 생성     │
    │                     │                       │─────┐               │
    │                     │                       │     │               │
    │                     │                       │◀────┘               │
    │                     │                       │                     │
    │                     │  UPLOAD_ACCEPT        │                     │
    │                     │  ┌──────────────────────────────────────┐   │
    │                     │  │ transfer_id: <uuid>                 │   │
    │                     │  └──────────────────────────────────────┘   │
    │                     │◀──────────────────────│                     │
    │                     │                       │                     │
    │                     │                       │                     │
    │                     │    CHUNK_DATA [0]     │                     │
    │                     │──────────────────────▶│                     │
    │  on_progress(0.25%) │                       │                     │
    │◀────────────────────│    CHUNK_ACK [0]      │                     │
    │                     │◀──────────────────────│                     │
    │                     │                       │                     │
    │                     │    CHUNK_DATA [1..N]  │                     │
    │                     │ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ▶│                     │
    │                     │                       │                     │
    │  on_progress(100%)  │   CHUNK_ACK [1..N]    │                     │
    │◀────────────────────│◀─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                     │
    │                     │                       │                     │
    │                     │  UPLOAD_COMPLETE      │                     │
    │                     │──────────────────────▶│                     │
    │                     │                       │                     │
    │                     │                       │  SHA-256 검증       │
    │                     │                       │  스토리지로 이동    │
    │                     │                       │─────┐               │
    │                     │                       │     │               │
    │                     │                       │◀────┘               │
    │                     │                       │                     │
    │                     │  UPLOAD_VERIFY        │  on_upload_complete()
    │                     │  (verified=true)      │────────────────────▶│
    │  Result<transfer>   │◀──────────────────────│                     │
    │◀────────────────────│                       │                     │
    │                     │                       │                     │
    ▼                     ▼                       ▼                     ▼
```

### 업로드 거부

```
┌────────┐          ┌────────────┐          ┌────────────┐          ┌────────┐
│클라이언트│          │  네트워크   │          │   서버     │          │  서버  │
│  앱     │          │            │          │            │          │  앱    │
└───┬────┘          └─────┬──────┘          └─────┬──────┘          └───┬────┘
    │                     │                       │                     │
    │  upload_file(10GB_file)                     │                     │
    │────────────────────▶│                       │                     │
    │                     │                       │                     │
    │                     │  UPLOAD_REQUEST       │                     │
    │                     │  (file_size: 10GB)    │                     │
    │                     │──────────────────────▶│                     │
    │                     │                       │                     │
    │                     │                       │  on_upload_request()│
    │                     │                       │────────────────────▶│
    │                     │                       │                     │
    │                     │                       │  return false       │
    │                     │                       │  (파일이 너무 큼)   │
    │                     │                       │◀────────────────────│
    │                     │                       │                     │
    │                     │  UPLOAD_REJECT        │                     │
    │                     │  ┌──────────────────────────────────────┐   │
    │                     │  │ error_code: -713 (upload_rejected)  │   │
    │                     │  │ reason: "파일 크기가 제한 초과"      │   │
    │                     │  └──────────────────────────────────────┘   │
    │                     │◀──────────────────────│                     │
    │                     │                       │                     │
    │  Result<error>      │                       │                     │
    │  (-713: upload_rejected)                    │                     │
    │◀────────────────────│                       │                     │
    │                     │                       │                     │
    ▼                     ▼                       ▼                     ▼
```

---

## 다운로드 흐름

### 완전한 다운로드 (서버 → 클라이언트)

```
┌────────┐          ┌────────────┐          ┌────────────┐          ┌────────┐
│클라이언트│          │ 클라이언트  │          │   서버     │          │  서버  │
│  앱     │          │ 파이프라인  │          │ 파이프라인  │          │  앱    │
└───┬────┘          └─────┬──────┘          └─────┬──────┘          └───┬────┘
    │                     │                       │                     │
    │  download_file(remote, local)               │                     │
    │────────────────────▶│                       │                     │
    │                     │                       │                     │
    │                     │  DOWNLOAD_REQUEST     │                     │
    │                     │  ┌──────────────────────────────────────┐   │
    │                     │  │ filename: "report.pdf"              │   │
    │                     │  └──────────────────────────────────────┘   │
    │                     │──────────────────────▶│                     │
    │                     │                       │                     │
    │                     │                       │ on_download_request()
    │                     │                       │────────────────────▶│
    │                     │                       │                     │
    │                     │                       │  return true (허용) │
    │                     │                       │◀────────────────────│
    │                     │                       │                     │
    │                     │                       │  파일 메타데이터 읽기│
    │                     │                       │─────┐               │
    │                     │                       │     │               │
    │                     │                       │◀────┘               │
    │                     │                       │                     │
    │                     │  DOWNLOAD_ACCEPT      │                     │
    │                     │  ┌──────────────────────────────────────┐   │
    │                     │  │ transfer_id: <uuid>                 │   │
    │                     │  │ file_size: 104857600                │   │
    │                     │  │ file_hash: <sha256>                 │   │
    │                     │  │ chunk_count: 400                    │   │
    │                     │  │ chunk_size: 262144                  │   │
    │                     │  │ compression: adaptive               │   │
    │                     │  └──────────────────────────────────────┘   │
    │                     │◀──────────────────────│                     │
    │                     │                       │                     │
    │                     │  로컬 파일 생성       │                     │
    │                     │─────┐                 │                     │
    │                     │     │                 │                     │
    │                     │◀────┘                 │                     │
    │                     │                       │                     │
    │                     │    CHUNK_DATA [0]     │                     │
    │                     │◀──────────────────────│                     │
    │  on_progress(0.25%) │                       │                     │
    │◀────────────────────│    CHUNK_ACK [0]      │                     │
    │                     │──────────────────────▶│                     │
    │                     │                       │                     │
    │                     │    CHUNK_DATA [1..N]  │                     │
    │                     │◀─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                     │
    │                     │                       │                     │
    │  on_progress(100%)  │   CHUNK_ACK [1..N]    │                     │
    │◀────────────────────│─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ▶│                     │
    │                     │                       │                     │
    │                     │  DOWNLOAD_COMPLETE    │                     │
    │                     │◀──────────────────────│                     │
    │                     │                       │                     │
    │                     │  SHA-256 검증         │                     │
    │                     │─────┐                 │                     │
    │                     │     │                 │                     │
    │                     │◀────┘                 │                     │
    │                     │                       │                     │
    │                     │  DOWNLOAD_VERIFY      │ on_download_complete()
    │                     │  (verified=true)      │────────────────────▶│
    │  Result<transfer>   │──────────────────────▶│                     │
    │◀────────────────────│                       │                     │
    │                     │                       │                     │
    ▼                     ▼                       ▼                     ▼
```

### 다운로드 - 파일 없음

```
┌────────┐          ┌────────────┐          ┌────────────┐
│클라이언트│          │  네트워크   │          │   서버     │
└───┬────┘          └─────┬──────┘          └─────┬──────┘
    │                     │                       │
    │  download_file("nonexistent.pdf")           │
    │────────────────────▶│                       │
    │                     │                       │
    │                     │  DOWNLOAD_REQUEST     │
    │                     │  (filename: "nonexistent.pdf")
    │                     │──────────────────────▶│
    │                     │                       │
    │                     │                       │  스토리지 확인
    │                     │                       │  파일 없음
    │                     │                       │─────┐
    │                     │                       │     │
    │                     │                       │◀────┘
    │                     │                       │
    │                     │  DOWNLOAD_REJECT      │
    │                     │  ┌──────────────────────────────────────┐
    │                     │  │ error_code: -746                    │
    │                     │  │ (file_not_found_on_server)          │
    │                     │  │ reason: "파일이 존재하지 않음"       │
    │                     │  └──────────────────────────────────────┘
    │                     │◀──────────────────────│
    │                     │                       │
    │  Result<error>      │                       │
    │  (-746: file_not_found_on_server)           │
    │◀────────────────────│                       │
    │                     │                       │
    ▼                     ▼                       ▼
```

---

## 파일 목록 조회

### 서버의 파일 목록 조회

```
┌────────┐          ┌────────────┐          ┌────────────┐
│클라이언트│          │  네트워크   │          │   서버     │
└───┬────┘          └─────┬──────┘          └─────┬──────┘
    │                     │                       │
    │  list_files("*.pdf")│                       │
    │────────────────────▶│                       │
    │                     │                       │
    │                     │  LIST_REQUEST         │
    │                     │  ┌──────────────────────────────────────┐
    │                     │  │ pattern: "*.pdf"                    │
    │                     │  │ offset: 0                           │
    │                     │  │ limit: 100                          │
    │                     │  └──────────────────────────────────────┘
    │                     │──────────────────────▶│
    │                     │                       │
    │                     │                       │  스토리지
    │                     │                       │  관리자 쿼리
    │                     │                       │─────┐
    │                     │                       │     │
    │                     │                       │◀────┘
    │                     │                       │
    │                     │  LIST_RESPONSE        │
    │                     │  ┌──────────────────────────────────────┐
    │                     │  │ total_count: 42                     │
    │                     │  │ returned_count: 42                  │
    │                     │  │ files: [                            │
    │                     │  │   {name: "report.pdf",              │
    │                     │  │    size: 1048576,                   │
    │                     │  │    modified: "2025-12-11T10:00:00Z"},│
    │                     │  │   {name: "invoice.pdf", ...},       │
    │                     │  │   ...                               │
    │                     │  │ ]                                   │
    │                     │  └──────────────────────────────────────┘
    │                     │◀──────────────────────│
    │                     │                       │
    │  Result<vector<file_info>>                  │
    │◀────────────────────│                       │
    │                     │                       │
    ▼                     ▼                       ▼
```

### 페이지네이션을 사용한 목록 조회

```
┌────────┐          ┌────────────┐          ┌────────────┐
│클라이언트│          │  네트워크   │          │   서버     │
└───┬────┘          └─────┬──────┘          └─────┬──────┘
    │                     │                       │
    │  list_files("*", offset=0, limit=50)        │
    │────────────────────▶│                       │
    │                     │  LIST_REQUEST         │
    │                     │──────────────────────▶│
    │                     │                       │
    │                     │  LIST_RESPONSE        │
    │                     │  (total=200, returned=50, files[0-49])
    │                     │◀──────────────────────│
    │  files[0-49]        │                       │
    │◀────────────────────│                       │
    │                     │                       │
    │  list_files("*", offset=50, limit=50)       │
    │────────────────────▶│                       │
    │                     │  LIST_REQUEST         │
    │                     │──────────────────────▶│
    │                     │                       │
    │                     │  LIST_RESPONSE        │
    │                     │  (total=200, returned=50, files[50-99])
    │                     │◀──────────────────────│
    │  files[50-99]       │                       │
    │◀────────────────────│                       │
    │                     │                       │
    │  ... 모든 페이지 조회 완료 ...               │
    │                     │                       │
    ▼                     ▼                       ▼
```

---

## 자동 재연결

### 네트워크 장애 후 재연결

```
┌────────┐          ┌────────────┐          ┌────────────┐
│클라이언트│          │  네트워크   │          │   서버     │
│  앱     │          │            │          │            │
└───┬────┘          └─────┬──────┘          └─────┬──────┘
    │                     │                       │
    │  연결됨, 업로드 진행 중                      │
    │                     │                       │
    │  CHUNK_DATA [0-99]  │                       │
    │────────────────────▶│──────────────────────▶│
    │                     │                       │
    │             ╔═══════════════════╗           │
    │             ║   네트워크 장애   ║           │
    │             ╚═══════════════════╝           │
    │                     │                       │
    │                     ╳                       │
    │                     │                       │
    │  on_disconnected(connection_lost)           │
    │◀────────────────────│                       │
    │                     │                       │
    │  on_reconnecting(attempt=1, delay=1s)       │
    │◀────────────────────│                       │
    │                     │                       │
    │  ═══ 1초 대기 ═══                           │
    │                     │                       │
    │                     │  TCP 연결             │
    │                     │──────────────────────╳│
    │                     │                       │
    │  on_reconnecting(attempt=2, delay=2s)       │
    │◀────────────────────│                       │
    │                     │                       │
    │  ═══ 2초 대기 ═══                           │
    │                     │                       │
    │                     │  TCP 연결             │
    │                     │──────────────────────▶│
    │                     │                       │
    │                     │  CONNECT              │
    │                     │──────────────────────▶│
    │                     │                       │
    │                     │  CONNECT_ACK          │
    │                     │◀──────────────────────│
    │                     │                       │
    │  on_reconnected()   │                       │
    │◀────────────────────│                       │
    │                     │                       │
    │  활성 전송 재개                              │
    │                     │                       │
    │                     │  RESUME_REQUEST       │
    │                     │  (transfer_id, received_chunks)
    │                     │──────────────────────▶│
    │                     │                       │
    │                     │  RESUME_RESPONSE      │
    │                     │  (resumable, missing_chunks)
    │                     │◀──────────────────────│
    │                     │                       │
    │  청크 100부터 계속                           │
    │  CHUNK_DATA [100..N]│                       │
    │────────────────────▶│──────────────────────▶│
    │                     │                       │
    ▼                     ▼                       ▼
```

### 재연결 실패 (최대 시도 횟수 초과)

```
┌────────┐          ┌────────────┐
│클라이언트│          │  네트워크   │
│  앱     │          │            │
└───┬────┘          └─────┬──────┘
    │                     │
    │  연결 끊김          │
    │                     │
    │  on_disconnected()  │
    │◀────────────────────│
    │                     │
    │  on_reconnecting(1, 1s)
    │◀────────────────────│
    │                     │
    │  ═══ 1초 대기 ═══   │
    │                     │
    │  연결 시도          ╳
    │                     │
    │  on_reconnecting(2, 2s)
    │◀────────────────────│
    │                     │
    │  ═══ 2초 대기 ═══   │
    │                     │
    │  연결 시도          ╳
    │                     │
    │      ... 계속       │
    │                     │
    │  on_reconnecting(10, 30s)
    │◀────────────────────│
    │                     │
    │  ═══ 30초 대기 ═══  │
    │                     │
    │  연결 시도          ╳
    │                     │
    │  최대 시도 횟수 도달 │
    │                     │
    │  on_reconnect_failed()
    │◀────────────────────│
    │                     │
    │  활성 전송이         │
    │  실패로 표시됨       │
    │                     │
    ▼                     ▼
```

---

## 전송 재개

### 재연결 후 재개

```
┌────────┐          ┌────────────┐          ┌────────┐
│클라이언트│          │  네트워크   │          │  서버  │
└───┬────┘          └─────┬──────┘          └───┬────┘
    │                     │                     │
    │  연결 해제 후 재연결됨                     │
    │                     │                     │
    │  활성 전송이 있음:                        │
    │  - transfer_id: <uuid>                    │
    │  - chunks_sent: [0-99]                    │
    │                     │                     │
    │  RESUME_REQUEST     │                     │
    │  ┌─────────────────────────────────┐      │
    │  │ transfer_id: <uuid>             │      │
    │  │ file_hash: <sha256>             │      │
    │  │ direction: upload               │      │
    │  │ chunks_sent: [0-99]             │      │
    │  └─────────────────────────────────┘      │
    │──────────────────────────────────────────▶│
    │                     │                     │
    │                     │                     │ 체크포인트 확인
    │                     │                     │ 파일 해시 검증
    │                     │                     │─────┐
    │                     │                     │     │
    │                     │                     │◀────┘
    │                     │                     │
    │  RESUME_RESPONSE    │                     │
    │  ┌─────────────────────────────────┐      │
    │  │ status: RESUMABLE               │      │
    │  │ chunks_received: [0-99]         │      │
    │  │ chunks_missing: [100-399]       │      │
    │  │ total_chunks: 400               │      │
    │  └─────────────────────────────────┘      │
    │◀──────────────────────────────────────────│
    │                     │                     │
    │  청크 100부터 재개                        │
    │                     │                     │
    │  CHUNK_DATA [100-399]                     │
    │─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ▶│
    │                     │                     │
    │  CHUNK_ACK [100-399]│                     │
    │◀─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │
    │                     │                     │
    │  UPLOAD_COMPLETE    │                     │
    │─────────────────────────────────────────▶│
    │                     │                     │
    │  UPLOAD_VERIFY      │                     │
    │◀──────────────────────────────────────────│
    │                     │                     │
    ▼                     ▼                     ▼
```

### 재개 상태

```
RESUME_RESPONSE 상태 값:

┌───────────────────────────────────────────────────────────────────────┐
│  RESUMABLE          │  체크포인트에서 전송 재개 가능                   │
├─────────────────────┼─────────────────────────────────────────────────┤
│  NOT_FOUND          │  서버에서 전송 ID를 찾을 수 없음                 │
├─────────────────────┼─────────────────────────────────────────────────┤
│  FILE_CHANGED       │  소스 파일 해시가 일치하지 않음                  │
├─────────────────────┼─────────────────────────────────────────────────┤
│  STATE_CORRUPTED    │  체크포인트 데이터가 손상됨                      │
├─────────────────────┼─────────────────────────────────────────────────┤
│  EXPIRED            │  체크포인트 만료 (설정 가능한 타임아웃)          │
└───────────────────────────────────────────────────────────────────────┘
```

---

## 청크 전송

### 단일 청크 수명 주기 (업로드)

```
┌────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────┐
│ 파일   │    │  io_read   │    │compression │    │  network   │    │  서버  │
│ 디스크 │    │   스테이지  │    │   스테이지  │    │   스테이지  │    │        │
└───┬────┘    └─────┬──────┘    └─────┬──────┘    └─────┬──────┘    └───┬────┘
    │               │                 │                 │               │
    │  read(offset) │                 │                 │               │
    │◀──────────────│                 │                 │               │
    │               │                 │                 │               │
    │  data[256KB]  │                 │                 │               │
    │──────────────▶│                 │                 │               │
    │               │                 │                 │               │
    │               │  청크 생성      │                 │               │
    │               │  CRC32 계산     │                 │               │
    │               │─────┐           │                 │               │
    │               │     │           │                 │               │
    │               │◀────┘           │                 │               │
    │               │                 │                 │               │
    │               │  큐에 푸시      │                 │               │
    │               │────────────────▶│                 │               │
    │               │                 │                 │               │
    │               │                 │  적응형 검사    │               │
    │               │                 │  압축 가능?     │               │
    │               │                 │─────┐           │               │
    │               │                 │     │           │               │
    │               │                 │◀────┘           │               │
    │               │                 │                 │               │
    │               │                 │  LZ4 압축       │               │
    │               │                 │─────┐           │               │
    │               │                 │     │           │               │
    │               │                 │◀────┘           │               │
    │               │                 │                 │               │
    │               │                 │  압축된 청크 푸시│              │
    │               │                 │────────────────▶│               │
    │               │                 │                 │               │
    │               │                 │                 │  직렬화       │
    │               │                 │                 │  CHUNK_DATA   │
    │               │                 │                 │─────┐         │
    │               │                 │                 │     │         │
    │               │                 │                 │◀────┘         │
    │               │                 │                 │               │
    │               │                 │                 │  전송         │
    │               │                 │                 │──────────────▶│
    │               │                 │                 │               │
    │               │                 │                 │  CHUNK_ACK    │
    │               │                 │                 │◀──────────────│
    │               │                 │                 │               │
    ▼               ▼                 ▼                 ▼               ▼
```

### 청크 재전송 (CRC32 실패)

```
┌────────┐                                    ┌────────┐
│클라이언트│                                    │  서버  │
└───┬────┘                                    └───┬────┘
    │                                             │
    │  CHUNK_DATA [chunk_idx=42]                  │
    │  ┌─────────────────────────────────┐        │
    │  │ data + checksum (CRC32)         │        │
    │  └─────────────────────────────────┘        │
    │────────────────────────────────────────────▶│
    │                                             │
    │                                             │ CRC32 검증
    │                                             │─────┐
    │                                             │     │ 불일치!
    │                                             │◀────┘
    │                                             │
    │  CHUNK_NACK [chunk_idx=42]                  │
    │  ┌─────────────────────────────────┐        │
    │  │ error_code: -720                │        │
    │  │ (chunk_checksum_error)          │        │
    │  └─────────────────────────────────┘        │
    │◀────────────────────────────────────────────│
    │                                             │
    │  다시 읽고 재전송                            │
    │                                             │
    │  CHUNK_DATA [chunk_idx=42]                  │
    │  ┌─────────────────────────────────┐        │
    │  │ data + checksum (재계산됨)      │        │
    │  └─────────────────────────────────┘        │
    │────────────────────────────────────────────▶│
    │                                             │
    │                                             │ CRC32 검증
    │                                             │─────┐
    │                                             │     │ OK
    │                                             │◀────┘
    │                                             │
    │  CHUNK_ACK [chunk_idx=42]                   │
    │◀────────────────────────────────────────────│
    │                                             │
    ▼                                             ▼
```

---

## 오류 처리

### 연결 오류

```
┌────────┐          ┌────────────┐          ┌────────┐
│클라이언트│          │  네트워크   │          │  서버  │
│  앱     │          │            │          │        │
└───┬────┘          └─────┬──────┘          └───┬────┘
    │                     │                     │
    │  connect()          │                     │
    │────────────────────▶│                     │
    │                     │                     │
    │                     │  TCP 연결           │
    │                     │─────────────────────╳ (연결 거부됨)
    │                     │                     │
    │                     │  백오프로 재시도    │
    │                     │  (auto_reconnect인 경우)
    │                     │─────────────────────╳
    │                     │                     │
    │                     │─────────────────────╳
    │                     │                     │
    │  Result<error>      │                     │
    │  (-700: connection_failed)                │
    │◀────────────────────│                     │
    │                     │                     │
    ▼                     ▼                     ▼
```

### 저장소 부족 오류

```
┌────────┐          ┌────────────┐          ┌────────┐
│클라이언트│          │  네트워크   │          │  서버  │
└───┬────┘          └─────┬──────┘          └───┬────┘
    │                     │                     │
    │  UPLOAD_REQUEST     │                     │
    │  (file_size: 50GB)  │                     │
    │────────────────────▶│────────────────────▶│
    │                     │                     │
    │                     │                     │ 저장소 할당량 확인
    │                     │                     │ (90GB 사용 / 100GB 할당량)
    │                     │                     │─────┐
    │                     │                     │     │
    │                     │                     │◀────┘
    │                     │                     │
    │  UPLOAD_REJECT      │                     │
    │  ┌──────────────────────────────────────┐ │
    │  │ error_code: -745 (storage_full)     │ │
    │  │ reason: "저장소 공간 부족"          │ │
    │  │ available: 10GB                     │ │
    │  │ requested: 50GB                     │ │
    │  └──────────────────────────────────────┘ │
    │◀────────────────────│◀────────────────────│
    │                     │                     │
    │  Result<error>      │                     │
    │  (-745: storage_full)                     │
    │◀────────────────────│                     │
    │                     │                     │
    ▼                     ▼                     ▼
```

---

## 파이프라인 처리

### 병렬 스테이지 실행

```
시간 ───────────────────────────────────────────────────────────────────▶

io_read    │▓▓▓▓│    │▓▓▓▓│    │▓▓▓▓│    │▓▓▓▓│    │▓▓▓▓│    │▓▓▓▓│
stage      │ C0 │    │ C1 │    │ C2 │    │ C3 │    │ C4 │    │ C5 │
           └────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┘

compress   │    │▓▓▓▓▓▓▓▓│    │▓▓▓▓▓▓▓▓│    │▓▓▓▓▓▓▓▓│    │▓▓▓▓▓▓▓▓│
stage      │    │   C0   │    │   C1   │    │   C2   │    │   C3   │
           └────┴────────┴────┴────────┴────┴────────┴────┴────────┘

network    │    │    │▓▓▓▓▓▓▓▓▓▓▓▓│    │▓▓▓▓▓▓▓▓▓▓▓▓│    │▓▓▓▓▓▓▓▓│
send       │    │    │     C0     │    │     C1     │    │   C2   │
           └────┴────┴────────────┴────┴────────────┴────┴────────┘

범례:
  ▓▓▓▓ = 청크 처리 중
  C0, C1, C2... = 청크 인덱스

핵심 통찰: 네트워크가 C0을 전송하는 동안, 압축은 C2를 처리하고,
io_read는 C5를 읽고 있습니다. 모든 스테이지가 병렬로 작동합니다!
```

### 백프레셔 동작

```
시나리오: 네트워크가 느려서 백프레셔 발생

시간에 따른 큐 상태:

T=0  read_queue:    [        ]     비어있음
     compress_queue:[        ]     비어있음
     send_queue:    [        ]     비어있음

T=1  read_queue:    [C0      ]     1 청크
     compress_queue:[        ]
     send_queue:    [        ]

T=5  read_queue:    [C1 C2   ]
     compress_queue:[C0 C1   ]
     send_queue:    [C0      ]     네트워크 전송 시작

T=20 read_queue:    [████████████████]  FULL (16)
     compress_queue:[████████████████████████████████]  FULL (32)
     send_queue:    [████████████████████████████████████████████████████████████████]  FULL (64)
                                      ↑ 네트워크 병목

T=21 io_read 스테이지가 큐 공간 대기 중 BLOCKS
     메모리 사용량이 ~32MB로 유지됨
     메모리 폭주 없음!

T=22 네트워크가 하나의 청크 전송
     send_queue:    [███████████████████████████████████████████████████████████████ ]
                                                                             ↑ 공간 확보됨

     압축 스테이지가 이제 푸시 가능
     io_read 스테이지가 블록 해제됨
```

---

## 하트비트 및 연결 관리

### 하트비트 메커니즘

```
┌────────┐                                    ┌────────┐
│클라이언트│                                    │  서버  │
└───┬────┘                                    └───┬────┘
    │                                             │
    │  연결 설정됨                                │
    │                                             │
    │  ═══ 15초 동안 데이터 없음 ═══               │
    │                                             │
    │  HEARTBEAT                                  │
    │────────────────────────────────────────────▶│
    │                                             │
    │  HEARTBEAT_ACK                              │
    │◀────────────────────────────────────────────│
    │                                             │
    │  연결이 활성 상태임을 확인                    │
    │                                             │
    │  ═══ 15초 동안 데이터 없음 ═══               │
    │                                             │
    │  HEARTBEAT                                  │
    │────────────────────────────────────────────▶│
    │                                             │
    │  [30초 내 응답 없음]                         │
    │                                             │
    │  연결 타임아웃                               │
    │  재연결 시작                                 │
    │                                             │
    ▼                                             ▼
```

---

*버전: 0.2.0*
*최종 업데이트: 2025-12-11*
