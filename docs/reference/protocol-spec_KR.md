# 프로토콜 명세

**file_trans_system** 라이브러리의 와이어 프로토콜 명세입니다.

## 개요

file_trans_system은 고성능 파일 전송을 위해 설계된 경량 커스텀 프로토콜을 사용합니다. 다음과 같은 이유로 **HTTP는 명시적으로 제외**됩니다:
- 높은 헤더 오버헤드 (~요청당 800바이트)
- 재개 기능과 충돌하는 무상태 설계
- 스트리밍 파일 전송에 불필요한 추상화

### 프로토콜 오버헤드 비교

| 프로토콜 | 청크당 오버헤드 | 총합 (1GB, 256KB 청크) | 백분율 |
|---------|----------------|----------------------|-------|
| HTTP/1.1 | ~800 바이트 | ~3.2 MB | 0.31% |
| **커스텀/TCP** | **54 바이트** | **~221 KB** | **0.02%** |
| 커스텀/QUIC | ~74 바이트 | ~303 KB | 0.03% |

---

## 전송 계층

### 지원 전송

| 전송 | 단계 | 기본값 | 설명 |
|------|------|-------|------|
| TCP + TLS 1.3 | Phase 1 | 예 | 모든 환경 |
| QUIC | Phase 2 | 아니오 | 높은 패킷 손실 네트워크, 모바일 |

### TLS 설정

```
최소 버전: TLS 1.3
암호 스위트:
  - TLS_AES_256_GCM_SHA384
  - TLS_CHACHA20_POLY1305_SHA256
  - TLS_AES_128_GCM_SHA256
```

---

## 프레임 형식

### 메시지 프레임 구조

```
┌────────────────────────────────────────────────────────────────┐
│                      프로토콜 프레임                            │
├────────────────────────────────────────────────────────────────┤
│ 메시지 타입     │ 1 바이트                                      │
├────────────────────────────────────────────────────────────────┤
│ 페이로드 길이   │ 4 바이트 (빅엔디안, 부호 없음)                 │
├────────────────────────────────────────────────────────────────┤
│ 페이로드        │ 가변 길이 (0 ~ 2^32-1 바이트)                  │
└────────────────────────────────────────────────────────────────┘

총 프레임 오버헤드: 5 바이트
```

### 바이트 레이아웃

```
오프셋  크기  필드
------  ----  -----
0       1     message_type
1       4     payload_length (빅엔디안)
5       N     payload
```

---

## 메시지 타입

### 메시지 타입 열거형

```cpp
enum class message_type : uint8_t {
    // 세션 관리 (0x01-0x0F)
    handshake_request   = 0x01,
    handshake_response  = 0x02,

    // 전송 제어 (0x10-0x1F)
    transfer_request    = 0x10,
    transfer_accept     = 0x11,
    transfer_reject     = 0x12,
    transfer_cancel     = 0x13,

    // 데이터 전송 (0x20-0x2F)
    chunk_data          = 0x20,
    chunk_ack           = 0x21,
    chunk_nack          = 0x22,  // 재전송 요청

    // 재개 (0x30-0x3F)
    resume_request      = 0x30,
    resume_response     = 0x31,

    // 완료 (0x40-0x4F)
    transfer_complete   = 0x40,
    transfer_verify     = 0x41,

    // 제어 (0xF0-0xFF)
    keepalive           = 0xF0,
    error               = 0xFF
};
```

### 메시지 타입 요약

| 코드 | 이름 | 방향 | 설명 |
|------|------|------|------|
| 0x01 | HANDSHAKE_REQUEST | C→S | 세션 시작 |
| 0x02 | HANDSHAKE_RESPONSE | S→C | 세션 수립 |
| 0x10 | TRANSFER_REQUEST | C→S | 파일 전송 요청 |
| 0x11 | TRANSFER_ACCEPT | S→C | 전송 수락 |
| 0x12 | TRANSFER_REJECT | S→C | 전송 거부 |
| 0x13 | TRANSFER_CANCEL | C↔S | 전송 취소 |
| 0x20 | CHUNK_DATA | C→S | 파일 청크 데이터 |
| 0x21 | CHUNK_ACK | S→C | 청크 확인응답 |
| 0x22 | CHUNK_NACK | S→C | 재전송 요청 |
| 0x30 | RESUME_REQUEST | C→S | 전송 재개 요청 |
| 0x31 | RESUME_RESPONSE | S→C | 재개 상태 응답 |
| 0x40 | TRANSFER_COMPLETE | C→S | 전송 완료 |
| 0x41 | TRANSFER_VERIFY | S→C | 검증 결과 |
| 0xF0 | KEEPALIVE | C↔S | 연결 유지 |
| 0xFF | ERROR | C↔S | 오류 알림 |

---

## 메시지 페이로드

### HANDSHAKE_REQUEST (0x01)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기      │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ protocol_version     │ 2 바이트  │ 프로토콜 버전 (major.minor)   │
│ capabilities         │ 4 바이트  │ 클라이언트 기능 비트맵        │
│ client_id            │ 16 바이트 │ 클라이언트 UUID               │
└─────────────────────────────────────────────────────────────────┘

총합: 22 바이트
```

**기능 비트맵:**
```
비트 0: 압축 지원 (LZ4)
비트 1: 재개 지원
비트 2: 배치 전송 지원
비트 3: QUIC 지원
비트 4-31: 예약
```

### HANDSHAKE_RESPONSE (0x02)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기      │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ protocol_version     │ 2 바이트  │ 협의된 프로토콜 버전          │
│ capabilities         │ 4 바이트  │ 협상된 기능                   │
│ session_id           │ 16 바이트 │ 세션 UUID                     │
│ max_chunk_size       │ 4 바이트  │ 최대 청크 크기 (바이트)       │
│ max_concurrent       │ 2 바이트  │ 최대 동시 전송 수             │
└─────────────────────────────────────────────────────────────────┘

총합: 28 바이트
```

### TRANSFER_REQUEST (0x10)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기      │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트 │ 전송 UUID                     │
│ file_count           │ 2 바이트  │ 파일 수                       │
│ compression_mode     │ 1 바이트  │ 요청된 압축 모드              │
│ compression_level    │ 1 바이트  │ 압축 수준                     │
│ options_flags        │ 4 바이트  │ 전송 옵션 비트맵              │
│ file_metadata[]      │ 가변      │ 파일 메타데이터 배열          │
└─────────────────────────────────────────────────────────────────┘
```

**파일 메타데이터 항목:**
```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기      │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ filename_length      │ 2 바이트  │ 파일명 문자열 길이            │
│ filename             │ 가변      │ UTF-8 인코딩 파일명           │
│ file_size            │ 8 바이트  │ 파일 크기 (바이트)            │
│ sha256_hash          │ 32 바이트 │ SHA-256 해시 (바이너리)       │
│ permissions          │ 4 바이트  │ 파일 권한                     │
│ modified_time        │ 8 바이트  │ Unix 타임스탬프 (마이크로초)  │
│ compressible_hint    │ 1 바이트  │ 압축 가능성 힌트              │
└─────────────────────────────────────────────────────────────────┘
```

### CHUNK_DATA (0x20)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기      │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트 │ 전송 UUID                     │
│ file_index           │ 8 바이트  │ 배치 내 파일 인덱스           │
│ chunk_index          │ 8 바이트  │ 청크 시퀀스 번호              │
│ chunk_offset         │ 8 바이트  │ 파일 내 바이트 오프셋         │
│ original_size        │ 4 바이트  │ 원본 (비압축) 크기            │
│ compressed_size      │ 4 바이트  │ 압축된 크기                   │
│ checksum             │ 4 바이트  │ 원본 데이터의 CRC32           │
│ flags                │ 1 바이트  │ 청크 플래그                   │
│ reserved             │ 3 바이트  │ 정렬용 패딩                   │
│ data                 │ 가변      │ 청크 데이터 (압축 또는 원본)  │
└─────────────────────────────────────────────────────────────────┘

헤더: 56 바이트 + 데이터
```

**청크 플래그:**
```
비트 0: first_chunk   - 파일의 첫 번째 청크
비트 1: last_chunk    - 파일의 마지막 청크
비트 2: compressed    - 데이터가 LZ4 압축됨
비트 3: encrypted     - TLS용 예약
비트 4-7: 예약
```

### CHUNK_ACK (0x21)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기      │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트 │ 전송 UUID                     │
│ file_index           │ 8 바이트  │ 파일 인덱스                   │
│ chunk_index          │ 8 바이트  │ 확인응답된 청크 인덱스        │
└─────────────────────────────────────────────────────────────────┘

총합: 32 바이트
```

### CHUNK_NACK (0x22)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기      │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트 │ 전송 UUID                     │
│ file_index           │ 8 바이트  │ 파일 인덱스                   │
│ chunk_count          │ 4 바이트  │ 누락 청크 수                  │
│ chunk_indices[]      │ 가변      │ 누락 청크 인덱스 배열         │
└─────────────────────────────────────────────────────────────────┘
```

### RESUME_REQUEST (0x30)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기      │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트 │ 재개할 전송 UUID              │
│ bitmap_size          │ 4 바이트  │ 청크 비트맵 크기 (바이트)     │
│ chunk_bitmap         │ 가변      │ 수신된 청크의 비트맵          │
└─────────────────────────────────────────────────────────────────┘
```

### RESUME_RESPONSE (0x31)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기      │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트 │ 전송 UUID                     │
│ can_resume           │ 1 바이트  │ 재개 가능 (0/1)               │
│ missing_count        │ 4 바이트  │ 누락 청크 수                  │
│ missing_indices[]    │ 가변      │ 누락 청크 인덱스 배열         │
└─────────────────────────────────────────────────────────────────┘
```

### TRANSFER_COMPLETE (0x40)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기      │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트 │ 전송 UUID                     │
│ file_index           │ 8 바이트  │ 완료된 파일 인덱스            │
│ bytes_sent           │ 8 바이트  │ 전송된 총 원시 바이트         │
│ bytes_on_wire        │ 8 바이트  │ 전송된 총 압축 바이트         │
└─────────────────────────────────────────────────────────────────┘

총합: 40 바이트
```

### TRANSFER_VERIFY (0x41)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기      │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트 │ 전송 UUID                     │
│ file_index           │ 8 바이트  │ 검증된 파일 인덱스            │
│ verified             │ 1 바이트  │ SHA-256 검증 결과             │
│ received_hash        │ 32 바이트 │ 계산된 SHA-256 해시           │
└─────────────────────────────────────────────────────────────────┘

총합: 57 바이트
```

### KEEPALIVE (0xF0)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기      │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ timestamp            │ 8 바이트  │ Unix 타임스탬프 (마이크로초)  │
└─────────────────────────────────────────────────────────────────┘

총합: 8 바이트
```

### ERROR (0xFF)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기      │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트 │ 관련 전송 (또는 0)            │
│ error_code           │ 4 바이트  │ 오류 코드 (부호 있음)         │
│ message_length       │ 2 바이트  │ 메시지 문자열 길이            │
│ message              │ 가변      │ UTF-8 오류 메시지             │
└─────────────────────────────────────────────────────────────────┘
```

---

## 프로토콜 흐름

### 일반 전송 시퀀스

```
    송신자                                    수신자
      │                                           │
      │─────── HANDSHAKE_REQUEST ────────────────▶│
      │                                           │
      │◀─────── HANDSHAKE_RESPONSE ──────────────│
      │                                           │
      │─────── TRANSFER_REQUEST ─────────────────▶│
      │                                           │
      │◀─────── TRANSFER_ACCEPT ─────────────────│
      │                                           │
      │─────── CHUNK_DATA (청크 0) ───────────────▶│
      │◀─────── CHUNK_ACK (청크 0) ───────────────│
      │                                           │
      │─────── CHUNK_DATA (청크 1) ───────────────▶│
      │◀─────── CHUNK_ACK (청크 1) ───────────────│
      │                                           │
      │            ... 청크 반복 ...              │
      │                                           │
      │─────── CHUNK_DATA (마지막, flags=0x02) ───▶│
      │◀─────── CHUNK_ACK ───────────────────────│
      │                                           │
      │─────── TRANSFER_COMPLETE ────────────────▶│
      │                                           │
      │◀─────── TRANSFER_VERIFY ─────────────────│
      │                                           │
```

### 재개 전송 시퀀스

```
    송신자                                    수신자
      │                                           │
      │─────── HANDSHAKE_REQUEST ────────────────▶│
      │◀─────── HANDSHAKE_RESPONSE ──────────────│
      │                                           │
      │─────── RESUME_REQUEST (비트맵 포함) ─────▶│
      │                                           │
      │◀─────── RESUME_RESPONSE (누락 목록) ─────│
      │                                           │
      │─────── CHUNK_DATA (누락 청크 5) ─────────▶│
      │◀─────── CHUNK_ACK ───────────────────────│
      │                                           │
      │─────── CHUNK_DATA (누락 청크 12) ────────▶│
      │◀─────── CHUNK_ACK ───────────────────────│
      │                                           │
      │            ... 남은 청크 ...              │
      │                                           │
      │─────── TRANSFER_COMPLETE ────────────────▶│
      │◀─────── TRANSFER_VERIFY ─────────────────│
      │                                           │
```

### 오류 처리 시퀀스

```
    송신자                                    수신자
      │                                           │
      │─────── CHUNK_DATA (손상) ─────────────────▶│
      │                                           │  CRC32 실패
      │◀─────── CHUNK_NACK (청크 5) ──────────────│
      │                                           │
      │─────── CHUNK_DATA (청크 5, 재시도) ───────▶│
      │◀─────── CHUNK_ACK (청크 5) ───────────────│
      │                                           │
```

---

## 상태 머신

### 연결 상태

```
                    ┌─────────────────┐
                    │   DISCONNECTED  │
                    └────────┬────────┘
                             │ connect()
                             ▼
                    ┌─────────────────┐
                    │   CONNECTING    │
                    └────────┬────────┘
                             │ 핸드셰이크 완료
                             ▼
                    ┌─────────────────┐
          ┌────────│    CONNECTED    │────────┐
          │        └────────┬────────┘        │
          │                 │                 │
          │ 오류            │ transfer_req    │ 취소
          │                 ▼                 │
          │        ┌─────────────────┐        │
          │        │  TRANSFERRING   │        │
          │        └────────┬────────┘        │
          │                 │ 완료            │
          │                 ▼                 │
          │        ┌─────────────────┐        │
          │        │    VERIFYING    │        │
          │        └────────┬────────┘        │
          │                 │                 │
          ▼                 ▼                 ▼
          ├─────────────────┴─────────────────┤
          │                                   │
          ▼                                   │
┌─────────────────┐                           │
│     FAILED      │◀──────────────────────────┘
└────────┬────────┘
         │ disconnect()
         ▼
┌─────────────────┐
│  DISCONNECTED   │
└─────────────────┘
```

---

## 버전 관리

### 프로토콜 버전 형식

```
Major: 1 바이트 (0-255)
Minor: 1 바이트 (0-255)

현재 버전: 1.0
```

### 버전 호환성

| 클라이언트 | 서버 | 결과 |
|-----------|------|------|
| 1.0 | 1.0 | 호환 |
| 1.0 | 1.1 | 호환 (서버 다운그레이드) |
| 1.1 | 1.0 | 호환 (클라이언트 다운그레이드) |
| 2.0 | 1.x | 비호환 (주 버전 불일치) |

---

## 보안 고려사항

### TLS 요구사항

- **최소 버전:** TLS 1.3
- **인증서 검증:** 프로덕션에서 필수
- **순방향 비밀성:** 기본 활성화

### 경로 순회 방지

TRANSFER_REQUEST의 파일명은 검증됩니다:
- `..` 컴포넌트 없음
- 절대 경로 없음
- UTF-8 정제

### 리소스 제한

| 제한 | 기본값 | 설정 가능 |
|------|-------|----------|
| 최대 청크 크기 | 1 MB | 예 |
| 최대 파일 크기 | 100 GB | 예 |
| 배치당 최대 파일 수 | 10,000 | 예 |
| 최대 동시 전송 | 100 | 예 |

---

*최종 업데이트: 2025-12-11*
