# 프로토콜 명세

**file_trans_system** 라이브러리의 와이어 프로토콜 명세입니다.

**버전**: 2.0.0
**최종 업데이트**: 2025-12-11

## 개요

file_trans_system은 클라이언트와 중앙 서버 간의 고성능 **양방향 파일 전송**을 위해 설계된 경량 커스텀 프로토콜을 사용합니다. 다음과 같은 이유로 **HTTP는 명시적으로 제외**됩니다:
- 높은 헤더 오버헤드 (~요청당 800바이트)
- 재개 기능과 충돌하는 무상태 설계
- 스트리밍 파일 전송에 불필요한 추상화

### 프로토콜 기능

- **양방향 전송**: 업로드 (클라이언트→서버) 및 다운로드 (서버→클라이언트)
- **파일 목록 조회**: 서버의 사용 가능한 파일 쿼리
- **연결 관리**: 세션 수립, 하트비트, 자동 재연결
- **재개 지원**: 체크포인트 기반 중단된 전송 복구
- **압축**: 적응형 LZ4 압축

### 프로토콜 오버헤드 비교

| 프로토콜 | 청크당 오버헤드 | 총합 (1GB, 256KB 청크) | 백분율 |
|---------|----------------|----------------------|-------|
| HTTP/1.1 | ~800 바이트 | ~3.2 MB | 0.31% |
| **커스텀/TCP** | **48 바이트** | **~196 KB** | **0.02%** |
| 커스텀/QUIC | ~68 바이트 | ~278 KB | 0.03% |

---

## 전송 계층

### 지원 전송

| 전송 | 단계 | 기본값 | 설명 |
|------|------|-------|------|
| TCP + TLS 1.3 | Phase 1 | 예 | 모든 환경 |
| QUIC | Phase 2 | 아니오 | 높은 패킷 손실 네트워크, 모바일 |

### TLS 설정

```
최소 버전: TLS 1.3
암호 스위트:
  - TLS_AES_256_GCM_SHA384
  - TLS_CHACHA20_POLY1305_SHA256
  - TLS_AES_128_GCM_SHA256
```

---

## 프레임 형식

### 메시지 프레임 구조

```
┌────────────────────────────────────────────────────────────────┐
│                      프로토콜 프레임                             │
├────────────────────────────────────────────────────────────────┤
│ 메시지 타입       │ 1 바이트                                     │
├────────────────────────────────────────────────────────────────┤
│ 페이로드 길이     │ 4 바이트 (빅엔디안, 부호 없음)                 │
├────────────────────────────────────────────────────────────────┤
│ 페이로드          │ 가변 길이 (0 ~ 2^32-1 바이트)                 │
└────────────────────────────────────────────────────────────────┘

총 프레임 오버헤드: 5 바이트
```

### 바이트 레이아웃

```
오프셋  크기  필드
------  ----  -----
0       1     message_type
1       4     payload_length (빅엔디안)
5       N     payload
```

---

## 메시지 타입

### 메시지 타입 열거형

```cpp
enum class message_type : uint8_t {
    // 세션 관리 (0x01-0x0F)
    connect             = 0x01,
    connect_ack         = 0x02,
    disconnect          = 0x03,
    heartbeat           = 0x04,
    heartbeat_ack       = 0x05,

    // 업로드 제어 (0x10-0x1F)
    upload_request      = 0x10,
    upload_accept       = 0x11,
    upload_reject       = 0x12,
    upload_complete     = 0x13,
    upload_ack          = 0x14,

    // 데이터 전송 (0x20-0x2F)
    chunk_data          = 0x20,
    chunk_ack           = 0x21,
    chunk_nack          = 0x22,  // 재전송 요청

    // 재개 (0x30-0x3F)
    resume_request      = 0x30,
    resume_response     = 0x31,

    // 전송 제어 (0x40-0x4F)
    transfer_cancel     = 0x40,
    transfer_pause      = 0x41,
    transfer_resume     = 0x42,
    transfer_verify     = 0x43,

    // 다운로드 제어 (0x50-0x5F)
    download_request    = 0x50,
    download_accept     = 0x51,
    download_reject     = 0x52,
    download_complete   = 0x53,
    download_ack        = 0x54,

    // 파일 목록 (0x60-0x6F)
    list_request        = 0x60,
    list_response       = 0x61,

    // 제어 (0xF0-0xFF)
    error               = 0xFF
};
```

### 메시지 타입 요약

| 코드 | 이름 | 방향 | 설명 |
|------|------|------|------|
| **세션 관리** |
| 0x01 | CONNECT | C→S | 클라이언트 연결 요청 |
| 0x02 | CONNECT_ACK | S→C | 서버가 연결 승인 |
| 0x03 | DISCONNECT | C↔S | 정상 연결 해제 |
| 0x04 | HEARTBEAT | C→S | 연결 유지 핑 |
| 0x05 | HEARTBEAT_ACK | S→C | 연결 유지 퐁 |
| **업로드 (클라이언트 → 서버)** |
| 0x10 | UPLOAD_REQUEST | C→S | 파일 업로드 요청 |
| 0x11 | UPLOAD_ACCEPT | S→C | 업로드 승인 |
| 0x12 | UPLOAD_REJECT | S→C | 업로드 거부 + 사유 |
| 0x13 | UPLOAD_COMPLETE | C→S | 모든 청크 전송 완료 |
| 0x14 | UPLOAD_ACK | S→C | 파일 완전 수신 + 검증됨 |
| **데이터 전송** |
| 0x20 | CHUNK_DATA | C↔S | 청크 페이로드 (양방향) |
| 0x21 | CHUNK_ACK | C↔S | 청크 확인 |
| 0x22 | CHUNK_NACK | C↔S | 재전송 요청 |
| **재개** |
| 0x30 | RESUME_REQUEST | C→S | 전송 재개 요청 |
| 0x31 | RESUME_RESPONSE | S→C | 재개 상태 응답 |
| **전송 제어** |
| 0x40 | TRANSFER_CANCEL | C↔S | 전송 취소 |
| 0x41 | TRANSFER_PAUSE | C→S | 전송 일시 중지 |
| 0x42 | TRANSFER_RESUME | C→S | 일시 중지된 전송 재개 |
| 0x43 | TRANSFER_VERIFY | S→C | 검증 결과 |
| **다운로드 (서버 → 클라이언트)** |
| 0x50 | DOWNLOAD_REQUEST | C→S | 파일 다운로드 요청 |
| 0x51 | DOWNLOAD_ACCEPT | S→C | 다운로드 승인 + 메타데이터 |
| 0x52 | DOWNLOAD_REJECT | S→C | 다운로드 거부 + 사유 |
| 0x53 | DOWNLOAD_COMPLETE | S→C | 모든 청크 전송 완료 |
| 0x54 | DOWNLOAD_ACK | C→S | 파일 완전 수신 + 검증됨 |
| **파일 목록** |
| 0x60 | LIST_REQUEST | C→S | 파일 목록 요청 |
| 0x61 | LIST_RESPONSE | S→C | 파일 목록 + 메타데이터 |
| **제어** |
| 0xFF | ERROR | C↔S | 오류 알림 |

---

## 메시지 페이로드

### CONNECT (0x01)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ protocol_version     │ 2 바이트 │ 프로토콜 버전 (major.minor)   │
│ capabilities         │ 4 바이트 │ 클라이언트 기능 비트맵        │
│ client_id            │ 16 바이트│ 클라이언트 UUID (선택, 또는 0)│
└─────────────────────────────────────────────────────────────────┘

총: 22 바이트
```

**기능 비트맵:**
```
비트 0: 압축 지원 (LZ4)
비트 1: 재개 지원
비트 2: 배치 전송 지원 (업로드)
비트 3: QUIC 지원 (Phase 2)
비트 4: 자동 재연결 활성화
비트 5-31: 예약됨
```

### CONNECT_ACK (0x02)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ protocol_version     │ 2 바이트 │ 합의된 프로토콜 버전          │
│ capabilities         │ 4 바이트 │ 협상된 기능                   │
│ session_id           │ 16 바이트│ 세션 UUID                     │
│ max_chunk_size       │ 4 바이트 │ 최대 청크 크기 (바이트)       │
│ max_file_size        │ 8 바이트 │ 허용된 최대 파일 크기         │
│ server_name_length   │ 2 바이트 │ 서버 이름 문자열 길이         │
│ server_name          │ 가변    │ UTF-8 서버 식별자             │
└─────────────────────────────────────────────────────────────────┘

최소: 36 바이트 + server_name
```

### DISCONNECT (0x03)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ reason_code          │ 4 바이트 │ 연결 해제 사유 코드           │
│ message_length       │ 2 바이트 │ 메시지 문자열 길이            │
│ message              │ 가변    │ UTF-8 사유 메시지             │
└─────────────────────────────────────────────────────────────────┘
```

### HEARTBEAT (0x04) / HEARTBEAT_ACK (0x05)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ timestamp            │ 8 바이트 │ Unix 타임스탬프 (마이크로초)  │
│ sequence             │ 4 바이트 │ 시퀀스 번호                   │
└─────────────────────────────────────────────────────────────────┘

총: 12 바이트
```

---

## 업로드 메시지

### UPLOAD_REQUEST (0x10)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트│ 전송 UUID                     │
│ filename_length      │ 2 바이트 │ 원격 파일명 문자열 길이       │
│ filename             │ 가변    │ UTF-8 원격 파일명             │
│ file_size            │ 8 바이트 │ 파일 크기 (바이트)            │
│ sha256_hash          │ 32 바이트│ SHA-256 해시 (바이너리)       │
│ compression_mode     │ 1 바이트 │ 요청된 압축 모드              │
│ options_flags        │ 4 바이트 │ 전송 옵션 비트맵              │
│ resume_from          │ 8 바이트 │ 재개 오프셋 (새로운 경우 0)   │
└─────────────────────────────────────────────────────────────────┘

최소: 71 바이트 + filename
```

**옵션 플래그:**
```
비트 0: overwrite_existing - 파일 존재 시 덮어쓰기
비트 1: verify_checksum    - SHA-256 검증 요구
비트 2: preserve_timestamp - 수정 시간 보존
비트 3-31: 예약됨
```

### UPLOAD_ACCEPT (0x11)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트│ 전송 UUID                     │
│ accepted_compression │ 1 바이트 │ 합의된 압축 모드              │
│ chunk_size           │ 4 바이트 │ 합의된 청크 크기              │
│ resume_offset        │ 8 바이트 │ 시작 오프셋 (재개용)          │
└─────────────────────────────────────────────────────────────────┘

총: 29 바이트
```

### UPLOAD_REJECT (0x12)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트│ 전송 UUID                     │
│ reason_code          │ 4 바이트 │ 거부 사유 코드                │
│ message_length       │ 2 바이트 │ 메시지 문자열 길이            │
│ message              │ 가변    │ UTF-8 오류 메시지             │
└─────────────────────────────────────────────────────────────────┘
```

**거부 사유 코드:**
```
-744: file_already_exists
-745: storage_full
-746: file_too_large
-747: access_denied
-748: invalid_filename
-749: quota_exceeded
```

### UPLOAD_COMPLETE (0x13)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트│ 전송 UUID                     │
│ total_chunks         │ 8 바이트 │ 전송된 총 청크 수             │
│ bytes_sent           │ 8 바이트 │ 전송된 총 원본 바이트         │
│ bytes_on_wire        │ 8 바이트 │ 전송된 총 압축 바이트         │
└─────────────────────────────────────────────────────────────────┘

총: 40 바이트
```

### UPLOAD_ACK (0x14)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트│ 전송 UUID                     │
│ verified             │ 1 바이트 │ SHA-256 검증 결과             │
│ stored_path_length   │ 2 바이트 │ 저장 경로 문자열 길이         │
│ stored_path          │ 가변    │ UTF-8 파일 저장 경로          │
└─────────────────────────────────────────────────────────────────┘

최소: 19 바이트 + stored_path
```

---

## 다운로드 메시지

### DOWNLOAD_REQUEST (0x50)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트│ 전송 UUID                     │
│ filename_length      │ 2 바이트 │ 원격 파일명 문자열 길이       │
│ filename             │ 가변    │ UTF-8 다운로드할 파일명       │
│ compression_mode     │ 1 바이트 │ 요청된 압축 모드              │
│ resume_from          │ 8 바이트 │ 재개 오프셋 (새로운 경우 0)   │
└─────────────────────────────────────────────────────────────────┘

최소: 27 바이트 + filename
```

### DOWNLOAD_ACCEPT (0x51)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트│ 전송 UUID                     │
│ file_size            │ 8 바이트 │ 파일 크기 (바이트)            │
│ sha256_hash          │ 32 바이트│ SHA-256 해시 (바이너리)       │
│ accepted_compression │ 1 바이트 │ 합의된 압축 모드              │
│ chunk_size           │ 4 바이트 │ 합의된 청크 크기              │
│ total_chunks         │ 8 바이트 │ 총 청크 수                    │
│ resume_offset        │ 8 바이트 │ 시작 오프셋 (재개용)          │
│ modified_time        │ 8 바이트 │ 파일 수정 타임스탬프          │
└─────────────────────────────────────────────────────────────────┘

총: 85 바이트
```

### DOWNLOAD_REJECT (0x52)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트│ 전송 UUID                     │
│ reason_code          │ 4 바이트 │ 거부 사유 코드                │
│ message_length       │ 2 바이트 │ 메시지 문자열 길이            │
│ message              │ 가변    │ UTF-8 오류 메시지             │
└─────────────────────────────────────────────────────────────────┘
```

**거부 사유 코드:**
```
-746: file_not_found_on_server
-747: access_denied
```

### DOWNLOAD_COMPLETE (0x53)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트│ 전송 UUID                     │
│ total_chunks         │ 8 바이트 │ 전송된 총 청크 수             │
│ bytes_sent           │ 8 바이트 │ 전송된 총 원본 바이트         │
│ bytes_on_wire        │ 8 바이트 │ 전송된 총 압축 바이트         │
└─────────────────────────────────────────────────────────────────┘

총: 40 바이트
```

### DOWNLOAD_ACK (0x54)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트│ 전송 UUID                     │
│ verified             │ 1 바이트 │ SHA-256 검증 결과             │
│ bytes_received       │ 8 바이트 │ 수신된 총 바이트              │
└─────────────────────────────────────────────────────────────────┘

총: 25 바이트
```

---

## 파일 목록 메시지

### LIST_REQUEST (0x60)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ request_id           │ 16 바이트│ 요청 UUID                     │
│ pattern_length       │ 2 바이트 │ 패턴 문자열 길이              │
│ pattern              │ 가변    │ UTF-8 glob 패턴 (예: "*")     │
│ offset               │ 4 바이트 │ 페이지네이션 오프셋           │
│ limit                │ 4 바이트 │ 반환할 최대 항목 수           │
│ sort_by              │ 1 바이트 │ 정렬 필드 (0=name, 1=size, 2=time) │
│ sort_order           │ 1 바이트 │ 정렬 순서 (0=오름차순, 1=내림차순) │
└─────────────────────────────────────────────────────────────────┘

최소: 28 바이트 + pattern
```

### LIST_RESPONSE (0x61)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ request_id           │ 16 바이트│ 요청 UUID                     │
│ total_count          │ 4 바이트 │ 일치하는 총 파일 수           │
│ returned_count       │ 4 바이트 │ 이 응답의 파일 수             │
│ has_more             │ 1 바이트 │ 추가 결과 사용 가능           │
│ file_entries[]       │ 가변    │ file_entry 배열               │
└─────────────────────────────────────────────────────────────────┘
```

**파일 엔트리:**
```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ filename_length      │ 2 바이트 │ 파일명 문자열 길이            │
│ filename             │ 가변    │ UTF-8 파일명                  │
│ file_size            │ 8 바이트 │ 파일 크기 (바이트)            │
│ sha256_hash          │ 32 바이트│ SHA-256 해시 (바이너리)       │
│ created_time         │ 8 바이트 │ 생성 타임스탬프               │
│ modified_time        │ 8 바이트 │ 수정 타임스탬프               │
└─────────────────────────────────────────────────────────────────┘

엔트리당: 58 바이트 + filename
```

---

## 데이터 전송 메시지

### CHUNK_DATA (0x20)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트│ 전송 UUID                     │
│ chunk_index          │ 8 바이트 │ 청크 시퀀스 번호              │
│ chunk_offset         │ 8 바이트 │ 파일 내 바이트 오프셋         │
│ original_size        │ 4 바이트 │ 원본 (비압축) 크기            │
│ compressed_size      │ 4 바이트 │ 압축된 크기                   │
│ checksum             │ 4 바이트 │ 원본 데이터의 CRC32           │
│ flags                │ 1 바이트 │ 청크 플래그                   │
│ reserved             │ 3 바이트 │ 정렬용 패딩                   │
│ data                 │ 가변    │ 청크 데이터 (압축 또는 원본)  │
└─────────────────────────────────────────────────────────────────┘

헤더: 48 바이트 + data
```

**청크 플래그:**
```
비트 0: first_chunk   - 파일의 첫 번째 청크
비트 1: last_chunk    - 파일의 마지막 청크
비트 2: compressed    - 데이터가 LZ4 압축됨
비트 3: encrypted     - 암호화 예약
비트 4-7: 예약됨
```

### CHUNK_ACK (0x21)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트│ 전송 UUID                     │
│ chunk_index          │ 8 바이트 │ 확인된 청크 인덱스            │
└─────────────────────────────────────────────────────────────────┘

총: 24 바이트
```

### CHUNK_NACK (0x22)

```
┌─────────────────────────────────────────────────────────────────┐
│ 필드                 │ 크기     │ 설명                          │
├─────────────────────────────────────────────────────────────────┤
│ transfer_id          │ 16 바이트│ 전송 UUID                     │
│ chunk_count          │ 4 바이트 │ 누락된 청크 수                │
│ chunk_indices[]      │ 가변    │ 누락된 청크 인덱스 배열       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 프로토콜 흐름

### 연결 시퀀스

```
    클라이언트                                  서버
      │                                           │
      │──────────── CONNECT ─────────────────────▶│
      │                                           │  기능 검증
      │◀────────── CONNECT_ACK ──────────────────│
      │                                           │
      │◀──────────────────────────────────────────│
      │          (세션 수립 완료)                   │
      │                                           │
```

### 업로드 시퀀스 (클라이언트 → 서버)

```
    클라이언트                                  서버
      │                                           │
      │──────── UPLOAD_REQUEST ─────────────────▶│
      │         (filename, size, hash)            │  할당량 확인, 검증
      │                                           │
      │◀─────── UPLOAD_ACCEPT ──────────────────│
      │         (chunk_size, resume_offset)       │
      │                                           │
      │──────── CHUNK_DATA (chunk 0) ───────────▶│
      │◀─────── CHUNK_ACK (chunk 0) ────────────│
      │                                           │
      │──────── CHUNK_DATA (chunk 1) ───────────▶│
      │◀─────── CHUNK_ACK (chunk 1) ────────────│
      │                                           │
      │            ... 추가 청크 ...               │
      │                                           │
      │──────── CHUNK_DATA (last, flags=0x02) ──▶│
      │◀─────── CHUNK_ACK ─────────────────────│
      │                                           │
      │──────── UPLOAD_COMPLETE ────────────────▶│
      │                                           │  SHA-256 검증
      │◀─────── UPLOAD_ACK ────────────────────│
      │         (verified, stored_path)           │
      │                                           │
```

### 다운로드 시퀀스 (서버 → 클라이언트)

```
    클라이언트                                  서버
      │                                           │
      │──────── DOWNLOAD_REQUEST ───────────────▶│
      │         (filename)                        │  파일 존재 확인
      │                                           │
      │◀─────── DOWNLOAD_ACCEPT ────────────────│
      │         (size, hash, total_chunks)        │
      │                                           │
      │◀─────── CHUNK_DATA (chunk 0) ───────────│
      │──────── CHUNK_ACK (chunk 0) ────────────▶│
      │                                           │
      │◀─────── CHUNK_DATA (chunk 1) ───────────│
      │──────── CHUNK_ACK (chunk 1) ────────────▶│
      │                                           │
      │            ... 추가 청크 ...               │
      │                                           │
      │◀─────── CHUNK_DATA (last, flags=0x02) ──│
      │──────── CHUNK_ACK ─────────────────────▶│
      │                                           │
      │◀─────── DOWNLOAD_COMPLETE ──────────────│
      │                                           │  클라이언트가 SHA-256 검증
      │──────── DOWNLOAD_ACK ──────────────────▶│
      │         (verified)                        │
      │                                           │
```

### 파일 목록 시퀀스

```
    클라이언트                                  서버
      │                                           │
      │──────── LIST_REQUEST ──────────────────▶│
      │         (pattern="*.pdf", limit=100)      │
      │                                           │
      │◀─────── LIST_RESPONSE ─────────────────│
      │         (total=250, returned=100,         │
      │          has_more=true, files[])          │
      │                                           │
      │──────── LIST_REQUEST ──────────────────▶│  (페이지네이션)
      │         (pattern="*.pdf", offset=100)     │
      │                                           │
      │◀─────── LIST_RESPONSE ─────────────────│
      │         (files[100..199])                 │
      │                                           │
```

---

## 상태 머신

### 클라이언트 연결 상태

```
                    ┌─────────────────┐
                    │  DISCONNECTED   │
                    └────────┬────────┘
                             │ connect()
                             ▼
                    ┌─────────────────┐
                    │   CONNECTING    │──────────────┐
                    └────────┬────────┘              │
                             │ CONNECT_ACK          │ timeout/error
                             ▼                       │
                    ┌─────────────────┐              │
          ┌────────│    CONNECTED    │──────┐       │
          │        └────────┬────────┘      │       │
          │                 │               │       │
          │ disconnect()    │               │ error │
          │                 ▼               │       │
          │        ┌─────────────────┐      │       │
          │        │  RECONNECTING   │◀─────┼───────┤
          │        │  (자동 재시도)   │      │       │
          │        └────────┬────────┘      │       │
          │                 │ success       │       │
          │                 ├───────────────┘       │
          │                 │ max_attempts          │
          │                 │ exceeded              │
          ▼                 ▼                       ▼
          ├─────────────────┴───────────────────────┤
          │                                         │
          ▼                                         │
┌─────────────────┐                                 │
│  DISCONNECTED   │◀────────────────────────────────┘
└─────────────────┘
```

### 전송 상태

```
                                    ┌──────────────┐
                                    │   pending    │
                                    └──────┬───────┘
                                           │
                                           │ request sent
                                           ▼
                                    ┌──────────────┐
                           ┌───────│  requested   │───────┐
                           │       └──────┬───────┘       │
                           │              │               │
                     reject│              │ accept        │ timeout
                           │              ▼               │
                           │       ┌──────────────┐       │
                           │   ┌──▶│ transferring │──┐    │
                           │   │   └──────┬───────┘  │    │
                           │   │          │          │    │
                           │   │ resume   │ complete │    │
                           │   │          ▼          │    │
                           │   │   ┌──────────────┐  │    │
                           │   └───│  verifying   │  │    │
                           │       └──────┬───────┘  │    │
                           │              │          │    │
                           │              │ verified │    │
                           │              ▼          │    │
                           │       ┌──────────────┐  │    │
                           │       │  completed   │  │    │
                           │       └──────────────┘  │    │
                           │                         │    │
                           │    cancel()             │    │
                           ▼                         ▼    ▼
                    ┌──────────────┐          ┌──────────────┐
                    │   rejected   │          │  cancelled   │
                    └──────────────┘          └──────────────┘
                           │                         │
                           └────────────┬────────────┘
                                        │
                                        ▼
                                 ┌──────────────┐
                                 │    failed    │
                                 └──────────────┘
```

---

## 버전 관리

### 프로토콜 버전 형식

```
Major: 1 바이트 (0-255)
Minor: 1 바이트 (0-255)

현재 버전: 2.0
```

### 버전 호환성

| 클라이언트 | 서버 | 결과 |
|-----------|------|------|
| 2.0 | 2.0 | 호환 |
| 2.0 | 2.1 | 호환 (서버 다운그레이드) |
| 2.1 | 2.0 | 호환 (클라이언트 다운그레이드) |
| 3.0 | 2.x | 비호환 (주 버전 불일치) |
| 1.x | 2.x | 비호환 (P2P vs 클라이언트-서버) |

---

## 보안 고려사항

### TLS 요구사항

- **최소 버전:** TLS 1.3
- **인증서 검증:** 프로덕션에서 필수
- **순방향 비밀성:** 기본 활성화

### 파일명 검증

UPLOAD_REQUEST 및 DOWNLOAD_REQUEST의 파일명이 검증됩니다:
- `..` 구성요소 없음 (경로 탐색 방지)
- 경로 구분자 없음 (`/` 또는 `\`)
- 절대 경로 없음
- UTF-8 정제
- 최대 길이: 255자
- 숨김 파일 없음 (앞에 `.`)
- 제어 문자 없음

### 리소스 제한

| 제한 | 기본값 | 설정 가능 |
|------|--------|----------|
| 최대 청크 크기 | 1 MB | 예 |
| 최대 파일 크기 | 10 GB | 예 |
| 저장소 할당량 | 1 TB | 예 |
| 최대 동시 연결 | 100 | 예 |
| 클라이언트당 최대 동시 전송 | 5 | 예 |
| 하트비트 간격 | 30초 | 예 |
| 연결 타임아웃 | 60초 | 예 |

---

*최종 업데이트: 2025-12-11*
*버전: 2.0.0*
